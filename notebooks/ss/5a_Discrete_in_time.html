
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Discrete Distributions in Time &#8212; Streamflow Distribution Estimation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/ss/5a_Discrete_in_time';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Streamflow Distribution Estimation - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Streamflow Distribution Estimation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../1_data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Methods.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_Predict_Runoff_Statistics.html">Predict Runoff Statistics from Catchment Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_Reference_Distributions.html">Reference Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_FDC_Estimation.html">FDC Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6_Large_Sample_Results_Comparison.html">Large Sample Comparison Results</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_estimation" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_estimation/issues/new?title=Issue%20on%20page%20%2Fnotebooks/ss/5a_Discrete_in_time.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/ss/5a_Discrete_in_time.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Discrete Distributions in Time</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#question-can-we-find-temporal-anomalies-in-pdfs">Question: Can we find temporal anomalies in PDFs?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-import-and-model-setup">Data Import and Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-cluster-numbers-to-stratify-k-fold-validation-clusters">Assign cluster numbers to stratify k-fold validation clusters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-load-the-results-to-avoid-repeat-loads-in-the-model-training-iterations">Pre-load the results to avoid repeat loads in the model training iterations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-cdfs-based-on-support-coverage-flags">Check CDFs based on support coverage flags</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-pairwise-attribute-comparisons">Load pairwise attribute comparisons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-attribute-groupings">Define attribute groupings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regression-problem">Regression Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-trial-parameters">Set trial parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split">Train-Test Split</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-regression-models">Run Regression Models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-results-of-d-kl-regression-test">Plot Results of <span class="math notranslate nohighlight">\(D_{KL}\)</span> Regression Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">Discussion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#is-the-distribution-of-values-inflating-the-coefficient-of-determination">Is the distribution of values inflating the coefficient of determination?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="discrete-distributions-in-time">
<h1>Discrete Distributions in Time<a class="headerlink" href="#discrete-distributions-in-time" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<section id="question-can-we-find-temporal-anomalies-in-pdfs">
<h3>Question: Can we find temporal anomalies in PDFs?<a class="headerlink" href="#question-can-we-find-temporal-anomalies-in-pdfs" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Quantize streamflow signal.</p></li>
<li><p>Make bins “selectable”.</p></li>
<li><p>highlight bin data in time series.</p></li>
<li><p>Do a test of temporal distribution of bin values.</p></li>
</ol>
<p>i.e. in the image below, does the “mode” around 1.5 <span class="math notranslate nohighlight">\(m^3/s\)</span> occur in one season or does it appear across many seasons?</p>
<p>Are there temporal clusters that have a periodicity, or is it a once in 36 year anomaly?</p>
<p><img alt="image.png" src="notebooks/ss/attachment:6244a636-9575-4c77-b080-4f1ec68bc92d.png" /></p>
</section>
</section>
<section id="data-import-and-model-setup">
<h2>Data Import and Model Setup<a class="headerlink" href="#data-import-and-model-setup" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xyzservices.providers</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xyz</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.layouts</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridplot</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">factor_cmap</span><span class="p">,</span> <span class="n">linear_cmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">LinearAxis</span><span class="p">,</span> <span class="n">Range1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">output_notebook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.palettes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sunset10</span><span class="p">,</span> <span class="n">Vibrant7</span><span class="p">,</span> <span class="n">Category20</span><span class="p">,</span> <span class="n">Bokeh6</span><span class="p">,</span> <span class="n">Bokeh7</span><span class="p">,</span> <span class="n">Bokeh8</span><span class="p">,</span> <span class="n">Greys256</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">config_context</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgglomerativeClustering</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">root_mean_squared_error</span><span class="p">,</span>
    <span class="n">mean_absolute_error</span><span class="p">,</span>
    <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span>
    <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">confusion_matrix</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">linregress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">kl_div</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax.scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span> <span class="k">as</span> <span class="n">jkde</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">jax_config</span>
<span class="n">jax_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">vmap</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">KDEpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFTKDE</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">data_processing_functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dpf</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># from sklearn.model_selection import StratifiedKFold</span>
<span class="n">output_notebook</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">45</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">vmap</span>
<span class="ne">---&gt; </span><span class="mi">45</span> <span class="kn">from</span><span class="w"> </span><span class="nn">KDEpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFTKDE</span>
<span class="g g-Whitespace">     </span><span class="mi">47</span> <span class="kn">import</span><span class="w"> </span><span class="nn">data_processing_functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dpf</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span> <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;KDEpy&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">tiles</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;USGS&#39;</span><span class="p">][</span><span class="s1">&#39;USTopo&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the catchment characteristics</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;BCUB_watershed_attributes_updated.csv&#39;</span>
<span class="n">attr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
<span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;log_drainage_area_km2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">])</span>
<span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;tmean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;tmin&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
<span class="n">station_ids</span> <span class="o">=</span> <span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">station_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> monitored basins in the attribute set.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 1325 monitored basins in the attribute set.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">centroids</span> <span class="o">=</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;centroid_lon_deg_e&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;centroid_lat_deg_n&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">attr_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">attr_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
<span class="n">attr_gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;unnamed: 0&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">attr_gdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># convert to BC Albers for computing distances</span>
<span class="n">attr_gdf</span> <span class="o">=</span> <span class="n">attr_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Div</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.layouts</span><span class="w"> </span><span class="kn">import</span> <span class="n">layout</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_plot</span><span class="p">(</span><span class="n">log_data</span><span class="p">):</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">log_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">log_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_edges</span><span class="p">)</span>

    <span class="c1"># convert density to mass</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">/=</span> <span class="n">cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pmf</span> <span class="o">/=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">yrs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">top</span><span class="o">=</span><span class="n">hist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Data (N=</span><span class="si">{</span><span class="n">yrs</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> yrs)&#39;</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">quantize_signal</span><span class="p">(</span><span class="n">target_stn</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="mi">6</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing </span><span class="si">{</span><span class="n">target_stn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># import streamflow data</span>
    <span class="n">stn_df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">stn</span><span class="p">)</span>
    <span class="n">stn_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_stn</span><span class="si">}</span><span class="s1">_uar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">stn_df</span><span class="p">[</span><span class="n">target_stn</span><span class="p">]</span> <span class="o">/</span> <span class="n">da</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">stn_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_stn</span><span class="si">}</span><span class="s1">_uar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">log_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span> 
    <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="n">le</span><span class="p">,</span> <span class="n">re</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">log_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">minx</span><span class="p">)</span> <span class="o">+</span> <span class="n">le</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">maxx</span><span class="p">)</span> <span class="o">+</span> <span class="n">re</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">)</span>
    <span class="n">lin_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_grid</span><span class="p">)</span>
    <span class="n">create_plot</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;05AD003&#39;</span><span class="p">,</span><span class="s1">&#39;05AD031&#39;</span><span class="p">,</span> <span class="s1">&#39;05AB022&#39;</span><span class="p">,</span> <span class="s1">&#39;05AB030&#39;</span><span class="p">,</span> <span class="s1">&#39;05AD031&#39;</span><span class="p">,</span> <span class="s1">&#39;12091050&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">attr_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">stn</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">]</span>
    <span class="n">quantize_signal</span><span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="n">da</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">asdf</span><span class="p">)</span>

    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing 05010500
</pre></div>
</div>
<div class="output text_html">
  <div id="d794feb3-941f-4f1c-994f-7d3e163ddd2e" data-root-id="p1001" style="display: contents;"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
  const docs_json = {"cb51535a-7efc-445f-a3ca-41aac21f00e4":{"version":"3.6.0","title":"Bokeh Application","roots":[{"type":"object","name":"Figure","id":"p1001","attributes":{"width":900,"height":450,"x_range":{"type":"object","name":"DataRange1d","id":"p1002"},"y_range":{"type":"object","name":"DataRange1d","id":"p1003"},"x_scale":{"type":"object","name":"LogScale","id":"p1010"},"y_scale":{"type":"object","name":"LinearScale","id":"p1011"},"title":{"type":"object","name":"Title","id":"p1008"},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1041","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1035","attributes":{"selected":{"type":"object","name":"Selection","id":"p1036","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1037"},"data":{"type":"map","entries":[["left",{"type":"ndarray","array":{"type":"bytes","data":"bhqQguZbAUAXAauIKtUCQAQ9bLx1bgRAeWjtL4AqBkAe/xkNPQwIQNfH9pnfFgpAJ7HwqeBNDEAdrHSFBLUOQOed7agwqBBAZFZGAjMSEkBn1pf28JoTQNls2nEGRRVAeUUUFEgTF0DaN7EByAgZQDdNeRzbKBtAaLYHrh53HUBH8mSNfvcfQJ0nHOUdVyFAFxJ09PnPIkA2TPtd1GgkQO4c+nNkJCZAcN5BkJwFKECafhIXrw8qQIpm6eYTRixA0Md4Po6sLkDFoGeRmaMwQLznSCg4DTJAOT0L4omVM0DMa5fyKT81QKLiQzLsDDdA/+rY7OEBOUAewBYZXyE7QPnPnAEAbz1Anj3SaK/uP0AldyCZVlJBQLauW87KykJAjtW9jDRjREBiu/JmSh5GQMDx6ub9/kdAysRfj4AISkB4lyJKST5MQDoWdEwapE5A5ja0vQOfUEDNvJutPghSQIAPokokkFNACy7TEE85VUAq0gwRkgZXQPZpr779+lhAQie0JeUZW0BQ+QSS42ZdQLHis7Hi5V9AtglAnpBNYUCH8vwVncViQO1jRkiWXWRA24NgCDIYZkBHZJQQYfhnQK/VUgJUAWpAoaEE04A2bEB6FcKuqJtuQMAjei1vmnBArgXekUYDckBGRfMvwIpzQPHAG8x1M3VA+3TzrzkAd0A="},"shape":[64],"dtype":"float64","order":"little"}],["right",{"type":"ndarray","array":{"type":"bytes","data":"FwGriCrVAkAEPWy8dW4EQHlo7S+AKgZAHv8ZDT0MCEDXx/aZ3xYKQCex8KngTQxAHax0hQS1DkDnne2oMKgQQGRWRgIzEhJAZ9aX9vCaE0DZbNpxBkUVQHlFFBRIExdA2jexAcgIGUA3TXkc2ygbQGi2B64edx1AR/JkjX73H0CdJxzlHVchQBcSdPT5zyJANkz7XdRoJEDuHPpzZCQmQHDeQZCcBShAmn4SF68PKkCKZunmE0YsQNDHeD6OrC5AxaBnkZmjMEC850goOA0yQDk9C+KJlTNAzGuX8ik/NUCi4kMy7Aw3QP/q2OzhATlAHsAWGV8hO0D5z5wBAG89QJ490miv7j9AJXcgmVZSQUC2rlvOyspCQI7VvYw0Y0RAYrvyZkoeRkDA8erm/f5HQMrEX4+ACEpAeJciSkk+TEA6FnRMGqROQOY2tL0Dn1BAzbybrT4IUkCAD6JKJJBTQAsu0xBPOVVAKtIMEZIGV0D2aa++/fpYQEIntCXlGVtAUPkEkuNmXUCx4rOx4uVfQLYJQJ6QTWFAh/L8FZ3FYkDtY0ZIll1kQNuDYAgyGGZAR2SUEGH4Z0Cv1VICVAFqQKGhBNOANmxAehXCrqibbkDAI3otb5pwQK4F3pFGA3JARkXzL8CKc0DxwBvMdTN1QPt08685AHdADJeudhv0eEA="},"shape":[64],"dtype":"float64","order":"little"}],["top",{"type":"ndarray","array":{"type":"bytes","data":"JR1HpuFPxz8jzLdK0IS1Py8Q9bgVsdw/rWctC43Lyz9tk0m0yFjbPxkQ9bgVsaw/4/fT8wsS1T8vEPW4FbGsP2FPDEaDLNQ/4/fT8wsS1T8PKpmTre7BP2Ogm6GU99U/4/fT8wsS1T+nxQ5UajXIPyPMt0rQhMU/GtkJOJwjwD8a2Qk4nCPAPyUdR6bhT8c/KW7WAfMayT8lHUem4U/HP4NnLQuNy8s/T27WAfMayT8Cv2VdBOa6PzkqmZOt7sE/Asy3StCExT8pbtYB8xq5P6Ej8JxHn9Q/m4HR5SQJwT8vEPW4FbHMPyPMt0rQhMU/swlMwq9hzz8rv2VdBObKP5uB0eUkCdE/JR1HpuFPxz+zCUzCr2HPP9xVtTzpe9E/W63tjmCW0D8xYYQUJ3zOP6fFDlRqNcg/Qf586nFh0j8CEPW4FbHMP/dVtTzpe9E/Vb9lXQTmyj+CgdHlJAnRPwLMt0rQhMU/toHR5SQJwT/BI/CcR5/UP4MJTMKvYc8/gwlMwq9hzz8CbtYB8xrJP3AqmZOt7sE/g2ctC43Lyz+CgdHlJAnRP4MWnq97AMo/LmgtC43Lyz+CdH/4WGrGPwIqmZOt7rE/AiqZk63uoT+zEPW4FbGcPwLMt0rQhJU/AAAAAAAAAAACEPW4FbF8PwAAAAAAAAAAqw/1uBWxjD8="},"shape":[64],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1042","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1043"}}},"glyph":{"type":"object","name":"Quad","id":"p1038","attributes":{"left":{"type":"field","field":"left"},"right":{"type":"field","field":"right"},"bottom":{"type":"value","value":0},"top":{"type":"field","field":"top"},"line_color":{"type":"value","value":"lightgreen"},"fill_color":{"type":"value","value":"lightgreen"},"fill_alpha":{"type":"value","value":0.5},"hatch_color":{"type":"value","value":"lightgreen"}}},"nonselection_glyph":{"type":"object","name":"Quad","id":"p1039","attributes":{"left":{"type":"field","field":"left"},"right":{"type":"field","field":"right"},"bottom":{"type":"value","value":0},"top":{"type":"field","field":"top"},"line_color":{"type":"value","value":"lightgreen"},"line_alpha":{"type":"value","value":0.1},"fill_color":{"type":"value","value":"lightgreen"},"fill_alpha":{"type":"value","value":0.1},"hatch_color":{"type":"value","value":"lightgreen"},"hatch_alpha":{"type":"value","value":0.1}}},"muted_glyph":{"type":"object","name":"Quad","id":"p1040","attributes":{"left":{"type":"field","field":"left"},"right":{"type":"field","field":"right"},"bottom":{"type":"value","value":0},"top":{"type":"field","field":"top"},"line_color":{"type":"value","value":"lightgreen"},"line_alpha":{"type":"value","value":0.2},"fill_color":{"type":"value","value":"lightgreen"},"fill_alpha":{"type":"value","value":0.2},"hatch_color":{"type":"value","value":"lightgreen"},"hatch_alpha":{"type":"value","value":0.2}}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1009","attributes":{"tools":[{"type":"object","name":"PanTool","id":"p1022"},{"type":"object","name":"WheelZoomTool","id":"p1023","attributes":{"renderers":"auto"}},{"type":"object","name":"BoxZoomTool","id":"p1024","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1025","attributes":{"syncable":false,"line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5,"level":"overlay","visible":false,"left":{"type":"number","value":"nan"},"right":{"type":"number","value":"nan"},"top":{"type":"number","value":"nan"},"bottom":{"type":"number","value":"nan"},"left_units":"canvas","right_units":"canvas","top_units":"canvas","bottom_units":"canvas","handles":{"type":"object","name":"BoxInteractionHandles","id":"p1031","attributes":{"all":{"type":"object","name":"AreaVisuals","id":"p1030","attributes":{"fill_color":"white","hover_fill_color":"lightgray"}}}}}}}},{"type":"object","name":"SaveTool","id":"p1032"},{"type":"object","name":"ResetTool","id":"p1033"},{"type":"object","name":"HelpTool","id":"p1034"}]}},"left":[{"type":"object","name":"LinearAxis","id":"p1017","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1018","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1019"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1020"}}}],"below":[{"type":"object","name":"LogAxis","id":"p1012","attributes":{"ticker":{"type":"object","name":"LogTicker","id":"p1013","attributes":{"num_minor_ticks":10,"mantissas":[1,5]}},"formatter":{"type":"object","name":"LogTickFormatter","id":"p1014"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1015"}}}],"center":[{"type":"object","name":"Grid","id":"p1016","attributes":{"axis":{"id":"p1012"}}},{"type":"object","name":"Grid","id":"p1021","attributes":{"dimension":1,"axis":{"id":"p1017"}}},{"type":"object","name":"Legend","id":"p1044","attributes":{"items":[{"type":"object","name":"LegendItem","id":"p1045","attributes":{"label":{"type":"value","value":"Data (N=4.8 yrs)"},"renderers":[{"id":"p1041"}]}}]}}]}}]}};
  const render_items = [{"docid":"cb51535a-7efc-445f-a3ca-41aac21f00e4","roots":{"p1001":"d794feb3-941f-4f1c-994f-7d3e163ddd2e"},"root_ids":["p1001"]}];
  void root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">line</span> <span class="mi">7</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">da</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">quantize_signal</span><span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="n">da</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="nb">print</span><span class="p">(</span><span class="n">asdf</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;asdf&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="assign-cluster-numbers-to-stratify-k-fold-validation-clusters">
<h2>Assign cluster numbers to stratify k-fold validation clusters<a class="headerlink" href="#assign-cluster-numbers-to-stratify-k-fold-validation-clusters" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the cluster information from the Methods section </span>
<span class="c1"># where we partitioned the graph to evaluate the distribution</span>
<span class="c1"># of the target variable across folds</span>
<span class="c1"># n_clusters = 15</span>
<span class="c1"># for spatial clustering</span>
<span class="c1"># cluster_fname = f&#39;stn_attributes_with_assigned_cluster_{n_clusters}.geojson&#39;</span>
<span class="c1"># for distributed classification (alternating labels spatially)</span>
<span class="n">n_classes</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">cluster_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;stn_attributes_with_</span><span class="si">{</span><span class="n">n_classes</span><span class="si">}</span><span class="s1">_spatial_partitions.geojson&#39;</span>
<span class="n">cluster_ids</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cluster_fname</span><span class="p">))</span>
<span class="n">cluster_ids</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># attr_df[&#39;cluster_id&#39;] = attr_df[&#39;official_id&#39;].apply(lambda x: cluster_ids.loc[cluster_ids[&#39;official_id&#39;] == x, &#39;cluster&#39;].values[0])</span>
<span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cluster_ids</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cluster_ids</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_classes</span><span class="si">}</span><span class="s1">_spatial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># check the number of station per fold</span>
<span class="n">f_unique</span><span class="p">,</span> <span class="n">f_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="pre-load-the-results-to-avoid-repeat-loads-in-the-model-training-iterations">
<h3>Pre-load the results to avoid repeat loads in the model training iterations<a class="headerlink" href="#pre-load-the-results-to-avoid-repeat-loads-in-the-model-training-iterations" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_label</span> <span class="o">=</span> <span class="s1">&#39;DKL_akde_LN_est&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dkl_df</span><span class="p">[</span><span class="n">target_label</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dkl_df</span><span class="p">[</span><span class="n">target_label</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">distribution_plots</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">dfig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span><span class="c1">#,</span>
             <span class="c1"># x_axis_type=&#39;log&#39;)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># compute empirical cdf of &quot;Actual&quot; Target</span>
<span class="c1"># values = partial_counts[c].copy().dropna()</span>
<span class="n">con_vals</span> <span class="o">=</span> <span class="n">dkl_df</span><span class="p">[</span><span class="n">target_label</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># print(f&#39;{b}bits, 10^{prior} prior min dkl: {minv:.1e}, max dkl: {maxv:.1F}&#39;)</span>
<span class="n">con_sample_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">con_vals</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>

<span class="c1"># Calculate the CDF values</span>
<span class="n">con_cdf_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">con_sample_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">con_sample_vals</span><span class="p">)</span>
<span class="n">dfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">con_sample_vals</span><span class="p">,</span> <span class="n">con_cdf_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Category20</span><span class="p">[</span><span class="mi">17</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> 
          <span class="n">line_width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Concurrent&#39;</span><span class="p">)</span>

<span class="n">dfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span><span class="s1">&#39;bottom_right&#39;</span>
<span class="n">dfig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$D_{\text</span><span class="si">{KL}</span><span class="s1">} [\text</span><span class="si">{bits}</span><span class="s1">/\text</span><span class="si">{sample}</span><span class="s1">]$$&#39;</span>
<span class="n">dfig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text</span><span class="si">{Pr}</span><span class="s1">(x \leq X)$$&#39;</span>
<span class="n">dfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">dfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span> <span class="o">=</span> <span class="s1">&#39;hide&#39;</span>
<span class="n">dfig</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">dfig</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show</span><span class="p">(</span><span class="n">dfig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-cdfs-based-on-support-coverage-flags">
<h3>Check CDFs based on support coverage flags<a class="headerlink" href="#check-cdfs-based-on-support-coverage-flags" title="Link to this heading">#</a></h3>
<p>Find the following:</p>
<ol class="arabic simple">
<li><p>Separate the dataset into two groups base on the <code class="docutils literal notranslate"><span class="pre">underspecified_model_flag</span></code> which represents models where the support of <span class="math notranslate nohighlight">\(Q\)</span> does not cover the support of <span class="math notranslate nohighlight">\(P\)</span>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dkl_df</span><span class="o">.</span><span class="n">columns</span>
<span class="n">dkl_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check for duplicate index entries</span>
<span class="n">dkl_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">dkl_df</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">dkl_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dkl_df</span><span class="p">))</span>
<span class="n">dkl_df</span> <span class="o">=</span> <span class="n">dkl_df</span><span class="p">[</span><span class="o">~</span><span class="n">dkl_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dkl_df</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="bp">cls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;concurrent&#39;</span><span class="p">,</span> <span class="s1">&#39;nonconcurrent&#39;</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="n">sc_df</span> <span class="o">=</span> <span class="n">dkl_df</span><span class="p">[</span><span class="n">dkl_df</span><span class="p">[</span><span class="s1">&#39;incomplete_target_support_coverage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">ncsc_df</span> <span class="o">=</span> <span class="n">dkl_df</span><span class="p">[</span><span class="n">dkl_df</span><span class="p">[</span><span class="s1">&#39;incomplete_target_support_coverage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">covered</span> <span class="o">=</span> <span class="n">sc_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">non_covered</span> <span class="o">=</span> <span class="n">ncsc_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">pct_concurrent_covered</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covered</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dkl_df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;N=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">covered</span><span class="p">)</span><span class="si">}</span><span class="s1"> (complete), N=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">non_covered</span><span class="p">)</span><span class="si">}</span><span class="s1"> (incomplete) coverage (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">pct_concurrent_covered</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
<span class="n">covered_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">covered</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>
<span class="n">noncovered_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_covered</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>
<span class="n">p50_covered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">covered</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">p50_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_covered</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">covered_pvals</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> 
       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Complete SC (Median=</span><span class="si">{</span><span class="n">p50_covered</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">noncovered_pvals</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> 
       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Incomplete SC (Median=</span><span class="si">{</span><span class="n">p50_nc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;top_left&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$D_{\text</span><span class="si">{KL}</span><span class="s1">} [\text</span><span class="si">{bits}</span><span class="s1">/\text</span><span class="si">{sample}</span><span class="s1">]$$&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$Pr(x \leq X)$$&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span><span class="o">=</span><span class="s1">&#39;hide&#39;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-pairwise-attribute-comparisons">
<h3>Load pairwise attribute comparisons<a class="headerlink" href="#load-pairwise-attribute-comparisons" title="Link to this heading">#</a></h3>
<p>Load a few rows from one of the pairwise data files.  These contain attributes about divergence measures that are computed on concurrent and non-concurrent time series at two monitored locations.</p>
</section>
<section id="define-attribute-groupings">
<h3>Define attribute groupings<a class="headerlink" href="#define-attribute-groupings" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">terrain</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation_m&#39;</span><span class="p">,</span> <span class="s1">&#39;slope_deg&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect_deg&#39;</span><span class="p">]</span> <span class="c1">#&#39;gravelius&#39;, &#39;perimeter&#39;,</span>
<span class="n">land_cover</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;land_use_forest_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_grass_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_wetland_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_water_frac_2010&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;land_use_urban_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_shrubs_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_crops_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_snow_ice_frac_2010&#39;</span><span class="p">]</span>
<span class="n">soil</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;logk_ice_x100&#39;</span><span class="p">,</span> <span class="s1">&#39;porosity_x100&#39;</span><span class="p">]</span>
<span class="n">climate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;prcp&#39;</span><span class="p">,</span> <span class="s1">&#39;srad&#39;</span><span class="p">,</span> <span class="s1">&#39;swe&#39;</span><span class="p">,</span> <span class="s1">&#39;tmax&#39;</span><span class="p">,</span> <span class="s1">&#39;tmin&#39;</span><span class="p">,</span> <span class="s1">&#39;vp&#39;</span><span class="p">,</span> <span class="s1">&#39;high_prcp_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;high_prcp_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;low_prcp_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;low_prcp_duration&#39;</span><span class="p">]</span>
<span class="n">all_attributes</span> <span class="o">=</span> <span class="n">terrain</span> <span class="o">+</span> <span class="n">land_cover</span> <span class="o">+</span> <span class="n">soil</span> <span class="o">+</span> <span class="n">climate</span>
<span class="nb">len</span><span class="p">(</span><span class="n">all_attributes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the fold dictionary to initialize the train/test split for each fold</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_fold_dict</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">cluster_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The fold ids are: </span><span class="si">{</span><span class="n">cluster_ids</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fold_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_ids</span><span class="p">:</span>
        <span class="n">cluster_stns</span> <span class="o">=</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># in-group edges</span>
        <span class="n">sample_AND</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cluster_stns</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cluster_stns</span><span class="p">))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># out-of-group edges</span>
        <span class="n">sample_NOR</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cluster_stns</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cluster_stns</span><span class="p">))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># assert that these are mutually exclusive groups</span>
        <span class="n">and_official_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sample_AND</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">sample_AND</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">nor_official_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sample_NOR</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">sample_NOR</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">and_official_ids</span><span class="p">,</span> <span class="n">nor_official_ids</span><span class="p">))))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;stations in list are not unique&#39;</span>
        <span class="n">fold_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">sample_AND</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">sample_NOR</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">fold_dict</span>        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">format_features</span><span class="p">(</span><span class="n">input_attributes</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">input_attributes</span><span class="p">:</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;proxy_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">features</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_attributes</span><span class="p">(</span><span class="n">attr_df</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">attribute_cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds attributes from the df_attributes to the df_relations based on the &#39;proxy&#39; and &#39;target&#39; columns</span>
<span class="sd">    using map for efficient lookups.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df_attributes (pd.DataFrame): DataFrame with &#39;id&#39; and attribute columns.</span>
<span class="sd">    df_relations (pd.DataFrame): DataFrame with &#39;proxy&#39; and &#39;target&#39; columns.</span>
<span class="sd">    attribute_cols (list of str): List of attribute columns to add to df_relations.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: Updated df_relations with added attribute columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create dictionaries for each attribute for quick lookup</span>
    <span class="n">attr_dicts</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">attribute_cols</span><span class="p">}</span>

    <span class="c1"># Add target attributes</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">attribute_cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;target_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">attr_dicts</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

    <span class="c1"># Add proxy attributes</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">attribute_cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;proxy_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">attr_dicts</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">attribute_cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;target_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;proxy_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> 

    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="regression-problem">
<h3>Regression Problem<a class="headerlink" href="#regression-problem" title="Link to this heading">#</a></h3>
<p>The same problem setup applies for the regression prediction problem which is to optimize the discriminant function and the input signal quantization simultaneously to minimize the error in predicting the KL divergence from catchment attributes.</p>
<p>Instead of predicting a scalar measure which is a feature of a single location, the key difference in this step is the target variable describes a measure of the difference in runoff between <strong>pairs of locations</strong>.  This approach asks whether the <strong>Kullback-Leibler Divergence</strong> (KLD) of the distribution of unit area runoff between two locations can be predicted from the attributes of both catchments (and their differences) using the gradient boosted decision tree method, which is also capable of predicting continuous variables, in this case <span class="math notranslate nohighlight">\(D_{KL}\)</span>.</p>
</section>
<section id="set-trial-parameters">
<h3>Set trial parameters<a class="headerlink" href="#set-trial-parameters" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the amount of data to set aside for final testing</span>
<span class="c1"># n_cv_folds = 5</span>
<span class="n">n_boost_rounds</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">random_seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">loss_function</span> <span class="o">=</span> <span class="s1">&#39;reg:absoluteerror&#39;</span>  <span class="c1"># L1 objective function for regression</span>

<span class="c1">#define if testing concurrent or nonconcurrent data</span>

<span class="c1"># partial counts refer to the test where observations were assigned</span>
<span class="c1"># a uniform distribution to approximate error and allow fractional </span>
<span class="c1"># observations in state space</span>

<span class="c1"># cross validation parameters</span>
<span class="n">optimize_cv_folds</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">cv_fold_seed</span> <span class="o">=</span> <span class="mi">83561</span>
<span class="n">n_cv_fold_optimization_trials</span> <span class="o">=</span> <span class="mi">15</span>
<span class="c1"># limit the maximum distance to make the network </span>
<span class="c1"># graph of station pairs more separable</span>
<span class="n">max_centroid_distance</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">attribute_set_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;proximity&#39;</span><span class="p">,</span> <span class="s1">&#39;+climate&#39;</span><span class="p">,</span> <span class="s1">&#39;+terrain&#39;</span><span class="p">,</span> <span class="s1">&#39;+land_cover&#39;</span><span class="p">,</span> <span class="s1">&#39;+soil&#39;</span><span class="p">]</span>
<span class="n">attribute_group_sets</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;centroid_distance&#39;</span><span class="p">],</span> <span class="n">climate</span><span class="p">,</span> <span class="n">terrain</span><span class="p">,</span> <span class="n">land_cover</span><span class="p">,</span> <span class="n">soil</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;prediction_results&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted_LN_kld_prediction_results&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">results_folder</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="train-test-split">
<h3>Train-Test Split<a class="headerlink" href="#train-test-split" title="Link to this heading">#</a></h3>
<p>The input dataset is pairwise comparisons of just over 1300 (streamflow) monitored catchments, their attributes, and the attribute differences.  After filtering for data concurrency (minimum 1 year, &lt; 5 days missing per month) and maximum distance between basin centroids (500 km) we are left with roughly 225K pairs.  The pairwise setup means that station data appears in more than one row.  As a result, the attributes of stations can end up in both training and test sets if we simply split by randomly assigning rows to training or test sets.   We can’t simply cut edges until the graph is separated because it is a <a class="reference external" href="https://en.wikipedia.org/wiki/Independent_set_(graph_theory)">generalization of the “keeping a subset of vertices” problem in graph theory which is NP-hard</a>.</p>
<p>To address this issue we split the dataset spatially to create partitioned datasets for each fold and draw samples from within the “cluster” while filtering all edges between the fold and the rest of the set.  The end goal is to generate training folds where the official_id does not appear in both training and test set, in either proxy or target column.  One problem remains, and that is to generate training and test sets with some assurance that the target variable distributions match to some degree, but this is less critical than ensuring there is no data leakage between training and test data.</p>
<p>Next we create training/test splits and visualize how the target variable distributions compare.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_empirical_cdf</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">sorted_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sorted_data</span><span class="p">,</span> <span class="n">cdf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_result_by_prior</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;kde_kld_prediction_results&#39;</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;kde_dkl_</span><span class="si">{</span><span class="n">concurrent</span><span class="si">}</span><span class="s1">_results.npy&#39;</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">train_xgb_model</span><span class="p">(</span>
    <span class="n">input_data</span><span class="p">,</span> <span class="n">fold_no</span><span class="p">,</span> <span class="n">cv_data</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">num_boost_rounds</span><span class="p">,</span> <span class="n">loss</span>
<span class="p">):</span>    
    <span class="n">test_idxs</span> <span class="o">=</span> <span class="n">cv_data</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="n">train_idxs</span> <span class="o">=</span> <span class="n">cv_data</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>   

    <span class="n">test_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">attributes</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">Y_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="c1"># Y_train = np.log10(train_data[target].values)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">attributes</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">Y_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="c1"># Y_test = np.log10(test_data[target].values)</span>

    <span class="c1"># model = xgb.XGBRegressor(**params)</span>

    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Y_train</span><span class="p">)</span>
    <span class="n">dtest</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Y_test</span><span class="p">)</span>

    <span class="n">eval_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dtrain</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">dtest</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">)]</span>
    <span class="n">evals_result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bst</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">dtrain</span><span class="p">,</span>
        <span class="n">num_boost_rounds</span><span class="p">,</span>
        <span class="n">evals</span><span class="o">=</span><span class="n">eval_list</span><span class="p">,</span>
        <span class="n">evals_result</span><span class="o">=</span><span class="n">evals_result</span><span class="p">,</span>
        <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">eval_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; setting eval key to </span><span class="si">{</span><span class="n">eval_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">eval_keys</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">eval_key</span> <span class="o">=</span> <span class="n">eval_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Convert the lists to NumPy arrays with dtype=object</span>
    <span class="n">train_perf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="n">eval_key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">test_perf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">][</span><span class="n">eval_key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">fold_progress</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="n">eval_key</span><span class="p">],</span>
        <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">][</span><span class="n">eval_key</span><span class="p">],</span>
        <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">fold_no</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="n">eval_key</span><span class="p">]),</span>
    <span class="p">})</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="n">bst</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dtest</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">,</span> <span class="n">fold_progress</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">Y_test</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_xgb_trials_custom_CV</span><span class="p">(</span>
    <span class="n">set_name</span><span class="p">,</span>
    <span class="n">attributes</span><span class="p">,</span>
    <span class="n">target</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">,</span>
    <span class="n">fold_dict</span><span class="p">,</span> 
    <span class="n">n_optimization_rounds</span><span class="p">,</span>
    <span class="n">num_boost_rounds</span><span class="p">,</span>
    <span class="n">results_folder</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;reg:squarederror&#39;</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom CV refers to cross validation.  Custom cross validation means the </span>
<span class="sd">    held-out set must be determined in a more robust way to avoid &quot;data leakage&quot;.</span>
<span class="sd">    That is, the pairs making up the training, validation, and test sets must </span>
<span class="sd">    be made up of pairings from unique sets of stations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># select random hyperparameters for n_optimization_rounds</span>
    <span class="n">sample_choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># subsample and colsample percentages</span>
    <span class="n">lr_choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0005</span><span class="p">)</span>  <span class="c1"># learning rates</span>
    <span class="n">learning_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">lr_choices</span><span class="p">,</span> <span class="n">n_optimization_rounds</span><span class="p">)</span>
    <span class="n">subsamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_choices</span><span class="p">,</span> <span class="n">n_optimization_rounds</span><span class="p">)</span>
    <span class="n">colsamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_choices</span><span class="p">,</span> <span class="n">n_optimization_rounds</span><span class="p">)</span>
    <span class="n">num_boost_rounds</span> <span class="o">=</span> <span class="n">num_boost_rounds</span>
    <span class="n">eval_key</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_result</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">best_params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_mean_test_perf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_convergence_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">best_trial_test_predictions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output_target_cdfs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_optimization_rounds</span><span class="p">):</span>
        <span class="n">lr</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">learning_rates</span><span class="p">[</span><span class="n">trial</span><span class="p">],</span> <span class="n">subsamples</span><span class="p">[</span><span class="n">trial</span><span class="p">],</span> <span class="n">colsamples</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
            <span class="s2">&quot;eta&quot;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span>
            <span class="c1"># &quot;max_depth&quot;: 6,  # use default max_depth</span>
            <span class="c1"># &quot;min_child_weight&quot;: 1, # use colsample and subsample instead of min_child_weight</span>
            <span class="s2">&quot;subsample&quot;</span><span class="p">:</span> <span class="n">ss</span><span class="p">,</span>
            <span class="s2">&quot;colsample_bytree&quot;</span><span class="p">:</span> <span class="n">cs</span><span class="p">,</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">random_seed</span><span class="p">,</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>  <span class="c1"># note, change this to &#39;cpu&#39; if your system doesn&#39;t have a CUDA GPU</span>
            <span class="s2">&quot;sampling_method&quot;</span><span class="p">:</span> <span class="s2">&quot;gradient_based&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tree_method&quot;</span><span class="p">:</span> <span class="s2">&quot;hist&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">results_fname</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">set_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">_lr_</span><span class="si">{</span><span class="n">ss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">_sub_</span><span class="si">{</span><span class="n">cs</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">_col.csv&quot;</span>
        <span class="p">)</span>
        <span class="n">results_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_folder</span><span class="p">,</span> <span class="n">results_fname</span><span class="p">)</span>

        <span class="c1"># k-fold cross validation</span>
        <span class="n">fold_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">fold_no</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_train_fold_perf</span><span class="p">,</span> <span class="n">best_test_fold_perf</span><span class="p">,</span> <span class="n">best_test_rounds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">all_fold_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fold_scores</span><span class="p">,</span> <span class="n">fold_arrays</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">target_cdfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fold_no</span><span class="p">,</span> <span class="n">cv_data</span> <span class="ow">in</span> <span class="n">fold_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">train_perf</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">,</span> <span class="n">fold_progress</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">train_xgb_model</span><span class="p">(</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">fold_no</span><span class="p">,</span>
                <span class="n">cv_data</span><span class="p">,</span>
                <span class="n">attributes</span><span class="p">,</span>
                <span class="n">target</span><span class="p">,</span>
                <span class="n">params</span><span class="p">,</span>
                <span class="n">num_boost_rounds</span><span class="p">,</span>
                <span class="n">loss</span>
            <span class="p">)</span>            
            <span class="n">fold_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_progress</span><span class="p">)</span>
            
            <span class="n">test_ids</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cv_data</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">test_ids</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">test_ids</span><span class="p">]</span>

            <span class="n">test_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;predicted&quot;</span><span class="p">:</span> <span class="n">predicted</span><span class="p">,</span> <span class="s2">&quot;actual&quot;</span><span class="p">:</span> <span class="n">Y_test</span><span class="p">,</span> <span class="s2">&quot;proxy_target&quot;</span><span class="p">:</span> <span class="n">test_ids</span><span class="p">}</span>
            <span class="p">)</span>
            
            <span class="n">ordered_data</span><span class="p">,</span> <span class="n">fold_cdf</span> <span class="o">=</span> <span class="n">compute_empirical_cdf</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span>
            <span class="n">target_cdfs</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">ordered_data</span><span class="p">,</span> <span class="n">fold_cdf</span><span class="p">)]</span>
            
            <span class="c1"># Get the round with the best validation score (out-of-sample performance)</span>
            <span class="n">best_perf_round_train</span><span class="p">,</span> <span class="n">best_perf_round_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">train_perf</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">test_perf</span><span class="p">)</span>
            
            <span class="c1"># Store the metrics at the best round (minimum risk)</span>
            <span class="n">train_perf_best</span> <span class="o">=</span> <span class="n">train_perf</span><span class="p">[</span><span class="n">best_perf_round_train</span><span class="p">]</span>
            <span class="n">test_perf_best</span> <span class="o">=</span> <span class="n">test_perf</span><span class="p">[</span><span class="n">best_perf_round_test</span><span class="p">]</span>

            <span class="n">best_train_fold_perf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_perf_best</span><span class="p">)</span>
            <span class="n">best_test_fold_perf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_perf_best</span><span class="p">)</span>
            <span class="n">best_test_rounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_perf_round_test</span><span class="p">)</span>
            <span class="n">all_fold_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

        <span class="n">all_test_predictions_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_fold_results</span><span class="p">)</span>
        <span class="n">convergence_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">fold_arrays</span><span class="p">)</span>    
        
        <span class="n">mean_test_perf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">best_test_fold_perf</span><span class="p">)</span>
        <span class="n">stdev_test_perf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">best_test_fold_perf</span><span class="p">)</span>
        <span class="c1"># # track the trial error metrics</span>
        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;trial&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">eval_key</span><span class="si">}</span><span class="s1">_mean&#39;</span><span class="p">:</span> <span class="n">mean_test_perf</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">eval_key</span><span class="si">}</span><span class="s1">_stdev&#39;</span><span class="p">:</span> <span class="n">stdev_test_perf</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="n">results_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">results_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trial</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">trial</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   completed </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_optimization_rounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">mean_test_perf</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">round</span><span class="p">(</span><span class="n">best_mean_test_perf</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">best_mean_test_perf</span> <span class="o">=</span> <span class="n">mean_test_perf</span>
            <span class="n">best_convergence_df</span> <span class="o">=</span> <span class="n">convergence_df</span>
            <span class="n">best_trial_test_predictions</span> <span class="o">=</span> <span class="n">all_test_predictions_df</span>
            <span class="n">output_target_cdfs</span> <span class="o">=</span> <span class="n">target_cdfs</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    New best result: </span><span class="si">{</span><span class="n">eval_key</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">mean_test_perf</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> (trial </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    
    <span class="c1"># save the best trial results</span>
    <span class="n">best_trial_test_predictions</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">results_fpath</span><span class="p">)</span>
    <span class="n">results_all_trials</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>
    <span class="c1"># get the mean and standard deviation of the error metrics over all trials</span>
    <span class="n">all_trials_mean</span> <span class="o">=</span> <span class="n">results_all_trials</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_</span><span class="si">{</span><span class="n">eval_key</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">all_trials_stdev</span> <span class="o">=</span> <span class="n">results_all_trials</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_</span><span class="si">{</span><span class="n">eval_key</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">all_trials_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="mi">2</span><span class="o">*</span><span class="n">all_trials_stdev</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mean (95% CI) </span><span class="si">{</span><span class="n">eval_key</span><span class="si">}</span><span class="s2"> (of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results_all_trials</span><span class="p">)</span><span class="si">}</span><span class="s2"> hyperparameter optimization rounds.)&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">best_params</span><span class="p">,</span> <span class="n">best_mean_test_perf</span><span class="p">,</span> <span class="n">best_convergence_df</span><span class="p">,</span> <span class="n">best_trial_test_predictions</span><span class="p">,</span> <span class="n">results_all_trials</span><span class="p">,</span> <span class="n">output_target_cdfs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">predict_KLD_from_attributes</span><span class="p">(</span><span class="n">attr_df</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target_variable</span><span class="p">,</span> <span class="n">max_centroid_distance</span><span class="p">,</span> <span class="n">results_folder</span><span class="p">,</span> 
                                <span class="n">loss_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_boost_rounds</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
                              <span class="n">optimize_cv_folds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_cv_fold_optimization_trials</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cv_fold_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                              <span class="p">):</span>

    <span class="n">all_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">target_variable</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># reduce the maximum distance separating pairs such that the </span>
    <span class="c1"># graph can be more evenly separated.  Too permissible a distance</span>
    <span class="c1"># filter increases the graph connectivity, making it difficult to</span>
    <span class="c1"># create cross validation folds with no data leakage.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;centroid_distance&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_centroid_distance</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s1"> pairs remaining after filtering by max distance of </span><span class="si">{</span><span class="n">max_centroid_distance</span><span class="si">}</span><span class="s1"> km&#39;</span><span class="p">)</span> 
    <span class="c1"># add the attributes into the input dataset</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">add_attributes</span><span class="p">(</span><span class="n">attr_df</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">all_attributes</span><span class="p">)</span>
    <span class="n">fold_dict</span> <span class="o">=</span> <span class="n">create_fold_dict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># add attribute groups successively</span>
    <span class="n">predictor_attributes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># make sure the order of attributes matches the attribute_set_names list</span>
    <span class="k">for</span> <span class="n">attribute_set</span><span class="p">,</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">attribute_group_sets</span><span class="p">,</span> <span class="n">attribute_set_names</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Processing </span><span class="si">{</span><span class="n">set_name</span><span class="si">}</span><span class="s1"> attribute set: </span><span class="si">{</span><span class="n">target_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># initialize the predictor variables (features)</span>
        <span class="n">predictor_attributes</span> <span class="o">+=</span> <span class="n">attribute_set</span>
        <span class="k">if</span> <span class="n">set_name</span> <span class="o">==</span> <span class="s1">&#39;proximity&#39;</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;centroid_distance&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">non_dist_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">predictor_attributes</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;centroid_distance&#39;</span><span class="p">]</span>
            <span class="n">pair_features</span> <span class="o">=</span> <span class="n">format_features</span><span class="p">(</span><span class="n">non_dist_features</span><span class="p">)</span>
            <span class="n">diff_features</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">_diff&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">non_dist_features</span><span class="p">]</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;centroid_distance&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pair_features</span> <span class="o">+</span> <span class="n">diff_features</span>    

        <span class="n">best_params</span><span class="p">,</span> <span class="n">best_mean_rmse</span><span class="p">,</span> <span class="n">best_convg_df</span><span class="p">,</span> <span class="n">best_trial_test_predictions</span><span class="p">,</span> <span class="n">results_all_trials</span><span class="p">,</span> <span class="n">target_cdfs</span> <span class="o">=</span> <span class="n">run_xgb_trials_custom_CV</span><span class="p">(</span>
                <span class="n">set_name</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target_variable</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">fold_dict</span><span class="p">,</span> 
                <span class="n">n_cv_fold_optimization_trials</span><span class="p">,</span> <span class="n">n_boost_rounds</span><span class="p">,</span> <span class="n">results_folder</span><span class="p">,</span> 
            <span class="n">loss</span><span class="o">=</span><span class="n">loss_function</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># store the test set predictions and actuals</span>
        <span class="n">all_results</span><span class="p">[</span><span class="n">set_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
            <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">results_all_trials</span><span class="p">,</span> 
            <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="n">best_convg_df</span><span class="p">,</span>
            <span class="s1">&#39;oos_predictions&#39;</span><span class="p">:</span> <span class="n">best_trial_test_predictions</span><span class="p">,</span>
            <span class="c1"># &#39;test_rmse&#39;: best_mean_rmse,</span>
            <span class="s1">&#39;test_mae&#39;</span><span class="p">:</span> <span class="n">best_mean_rmse</span><span class="p">,</span>
            <span class="s1">&#39;target_cdfs&#39;</span><span class="p">:</span> <span class="n">target_cdfs</span><span class="p">,</span>
        <span class="p">}</span> 
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_folder</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="run-regression-models">
<h2>Run Regression Models<a class="headerlink" href="#run-regression-models" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_results_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;kde_</span><span class="si">{</span><span class="n">target_label</span><span class="si">}</span><span class="s1">_results_</span><span class="si">{</span><span class="n">rev_date</span><span class="si">}</span><span class="s1">.npy&#39;</span>
<span class="n">test_results_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_folder</span><span class="p">,</span> <span class="n">test_results_fname</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_results_fpath</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processed and loading: &#39;</span><span class="p">,</span> <span class="n">test_results_fname</span><span class="p">)</span>
    <span class="n">all_test_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">test_results_fpath</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">all_test_results</span> <span class="o">=</span> <span class="n">predict_KLD_from_attributes</span><span class="p">(</span>
        <span class="n">attr_df</span><span class="p">,</span> <span class="n">dkl_df</span><span class="p">,</span> <span class="n">target_label</span><span class="p">,</span> <span class="n">max_centroid_distance</span><span class="p">,</span> <span class="n">results_folder</span><span class="p">,</span> 
        <span class="n">loss_function</span><span class="o">=</span><span class="n">loss_function</span><span class="p">,</span> <span class="n">n_boost_rounds</span><span class="o">=</span><span class="n">n_boost_rounds</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="n">optimize_cv_folds</span><span class="o">=</span><span class="n">optimize_cv_folds</span><span class="p">,</span> <span class="n">n_cv_fold_optimization_trials</span><span class="o">=</span><span class="n">n_cv_fold_optimization_trials</span><span class="p">,</span> 
        <span class="n">cv_fold_seed</span><span class="o">=</span><span class="n">cv_fold_seed</span><span class="p">,</span> 
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">test_results_fpath</span><span class="p">,</span> <span class="n">all_test_results</span><span class="p">)</span>
<span class="n">test_results_fpath</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">format_fig_fonts</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s1">&#39;Bitstream Charter&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label_text_font_size</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">font_size</span><span class="si">}</span><span class="s1">pt&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label_text_font_size</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">font_size</span><span class="si">}</span><span class="s1">pt&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">major_label_text_font_size</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">font_size</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s1">pt&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">major_label_text_font_size</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">font_size</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s1">pt&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label_text_font</span> <span class="o">=</span> <span class="n">font</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label_text_font</span> <span class="o">=</span> <span class="n">font</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">major_label_text_font</span> <span class="o">=</span> <span class="n">font</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">major_label_text_font</span> <span class="o">=</span> <span class="n">font</span>
    <span class="k">if</span> <span class="n">legend</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">label_text_font_size</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">font_size</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s1">pt&#39;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">label_text_font</span> <span class="o">=</span> <span class="n">font</span>
    <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">test_results_fpath</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-results-of-d-kl-regression-test">
<h2>Plot Results of <span class="math notranslate nohighlight">\(D_{KL}\)</span> Regression Test<a class="headerlink" href="#plot-results-of-d-kl-regression-test" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">KDEpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFTKDE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColorBar</span><span class="p">,</span> <span class="n">LinearColorMapper</span><span class="p">,</span> <span class="n">LogColorMapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.layouts</span><span class="w"> </span><span class="kn">import</span> <span class="n">column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">spearmanr</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_contour_map</span><span class="p">(</span><span class="n">best_result</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">contour_levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Observed vs. Predicted DKL(KDE_fit||LN_predicted)&quot;</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">best_result</span><span class="p">[[</span><span class="s1">&#39;actual&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spearman Correlation: </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">statistic</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> p=</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Ensure the input data is a 2D numpy array</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data must be a 2D array with shape (n_samples, 2).&quot;</span><span class="p">)</span>
    
    <span class="c1"># Estimate kernel density using FFTKDE</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">FFTKDE</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">)</span>
    <span class="n">grid_points</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">grid_size</span><span class="p">)</span>
    
    <span class="c1"># Reshape density into a grid</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">grid_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> 
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">grid_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c1"># Bokeh plot</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">match_aspect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">x_range</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
        <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="c1"># Define a color mapper</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="n">LinearColorMapper</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Viridis256&quot;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="c1"># mapper = LogColorMapper(palette=&quot;Viridis256&quot;, low=z.min(), high=z.max())</span>
    
    <span class="c1"># Add contour plot</span>
    <span class="n">p</span><span class="o">.</span><span class="n">image</span><span class="p">(</span>
        <span class="n">image</span><span class="o">=</span><span class="p">[</span><span class="n">z</span><span class="p">],</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">dw</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span>
        <span class="n">dh</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span>
        <span class="n">color_mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">max_actual</span> <span class="o">=</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">line_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_actual</span><span class="p">)</span>
    <span class="n">line_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">slope</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">intercept</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">line_x</span><span class="p">]</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">line_x</span><span class="p">,</span> <span class="n">line_y</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
           <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;R²=</span><span class="si">{</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> (Sprmn. </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">statistic</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> p=</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s1">.2E</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_actual</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_actual</span><span class="p">],</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
           <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;1:1&#39;</span><span class="p">)</span>
    
    <span class="c1"># Add contour lines</span>
    <span class="c1"># levels = np.linspace(z.min(), z.max(), contour_levels)</span>
    <span class="c1"># for level in levels:</span>
    <span class="c1">#     contour_indices = np.where(z &gt;= level)</span>
    <span class="c1">#     contour_x = x[contour_indices[1]]</span>
    <span class="c1">#     contour_y = y[contour_indices[0]]</span>
    <span class="c1">#     p.scatter(contour_x, contour_y, size=0.5, color=&quot;black&quot;, alpha=0.5)</span>
    
    <span class="c1"># Add a color bar</span>
    <span class="n">color_bar</span> <span class="o">=</span> <span class="n">ColorBar</span><span class="p">(</span><span class="n">color_mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">color_bar</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
    
    
    <span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Actual $$D_</span><span class="si">{KL}</span><span class="s1">$$ [bits/sample]&#39;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Predicted $$D_</span><span class="si">{KL}</span><span class="s1">$$ [bits/sample]&#39;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;top_left&#39;</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layout_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">reg_plots_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">res_r2_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">reg_plots_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">res_r2_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">test_rmse</span><span class="p">,</span> <span class="n">test_mae</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="s1">&#39;test_mae&#39;</span>

<span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">test_set</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">attribute_set_names</span><span class="p">]</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">attribute_set_names</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">})</span>
    
<span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (Q(θ|D))&#39;</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="n">attribute_set_names</span><span class="p">,</span> <span class="n">toolbar_location</span><span class="o">=</span><span class="s1">&#39;above&#39;</span><span class="p">,</span>
                <span class="n">output_backend</span><span class="o">=</span><span class="s1">&#39;webgl&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="n">attribute_set_names</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">plots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_range</span><span class="p">,</span> 
                 <span class="n">output_backend</span><span class="o">=</span><span class="s1">&#39;webgl&#39;</span><span class="p">,</span> <span class="n">toolbar_location</span><span class="o">=</span><span class="s1">&#39;above&#39;</span><span class="p">,</span>
                <span class="p">)</span>
<span class="c1"># fig.line(&#39;x&#39;, &#39;y1&#39;, legend_label=&#39;rmse&#39;, color=&#39;green&#39;, source=source, line_width=3)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">loss_function</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Attribute Group (additive)&#39;</span>
<span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;set&#39;</span><span class="p">:</span> <span class="n">attribute_set_names</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">})</span>
<span class="c1"># best_rmse_idx = result_df[&#39;rmse&#39;].idxmin()</span>
<span class="n">best_mae_idx</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
<span class="c1"># best_rmse_set = result_df.loc[best_rmse_idx, &#39;set&#39;]</span>
<span class="n">best_mae_set</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_mae_idx</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">]</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">best_mae_set</span><span class="p">]</span>
<span class="n">best_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">best_mae_set</span><span class="p">][</span><span class="s1">&#39;oos_predictions&#39;</span><span class="p">]</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">],</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

<span class="n">sfig</span> <span class="o">=</span> <span class="n">plot_contour_map</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
    
<span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sfig</span><span class="p">)</span>   

<span class="c1"># plot the test set convergence for the &#39;best&#39; trial</span>
<span class="n">cfig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Loss Curve (</span><span class="si">{</span><span class="n">best_mae_set</span><span class="si">}</span><span class="s1"> set)&#39;</span><span class="p">,)</span>
<span class="n">convergence_df</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">best_mae_set</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span>

<span class="c1"># Pivot the data to get separate columns for each fold</span>
<span class="n">train_pivot</span> <span class="o">=</span> <span class="n">convergence_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">test_pivot</span> <span class="o">=</span> <span class="n">convergence_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="c1"># Rename the columns to indicate folds</span>
<span class="n">train_pivot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;fold_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">train_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">test_pivot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;fold_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">test_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">train_pivot</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_pivot</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_pivot</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_pivot</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fold_nos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">convergence_df</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">])))</span>

<span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fold_nos</span><span class="p">:</span>
    <span class="n">cfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">test_pivot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test_pivot</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;fold_</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
    <span class="n">cfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">train_pivot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train_pivot</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;fold_</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
<span class="n">cfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">train_pivot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train_pivot</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> 
          <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;CV Mean (Train)&#39;</span><span class="p">)</span>
<span class="n">cfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">test_pivot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test_pivot</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
          <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;CV Mean (Test)&#39;</span><span class="p">)</span>

<span class="c1"># find the minimum predictive risk (optimal complexity)</span>
<span class="n">min_pred_risk_idx</span> <span class="o">=</span> <span class="n">test_pivot</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
<span class="k">if</span> <span class="n">min_pred_risk_idx</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_pivot</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Min prediction risk occurs at the maximum iteration, try increasing the number of boosting rounds&#39;</span><span class="p">)</span>

<span class="n">min_pred_risk</span> <span class="o">=</span> <span class="n">test_pivot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_pred_risk_idx</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span>
<span class="n">cfig</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">min_pred_risk_idx</span><span class="p">,</span> <span class="n">min_pred_risk_idx</span><span class="p">],</span> <span class="p">[</span><span class="n">train_pivot</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">min_pred_risk</span><span class="p">],</span> 
          <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;Min risk&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

<span class="n">cfig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text</span><span class="si">{Iteration}</span><span class="s1">$$&#39;</span>
<span class="n">cfig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{|x-y|} $$&#39;</span>
<span class="n">cfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">cfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;top_right&#39;</span>
<span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfig</span><span class="p">)</span>
<span class="c1"># plot a 1:1 line</span>
<span class="n">sfig</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">ybf</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ybf</span><span class="p">)],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">ybf</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ybf</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> 
          <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;1:1&#39;</span><span class="p">)</span>

<span class="c1"># plot the cdfs of the target variables in each fold to compare</span>
<span class="n">cdffig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Target Variable CDFs by fold&#39;</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">cdf_arrays</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">best_mae_set</span><span class="p">][</span><span class="s1">&#39;target_cdfs&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">cdfx</span><span class="p">,</span> <span class="n">cdfy</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cdf_arrays</span><span class="p">:</span>
    <span class="n">cdffig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">cdfx</span><span class="p">,</span> <span class="n">cdfy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdffig</span><span class="p">)</span>
<span class="n">cdffig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Observed Values } \text{[bits/sample]}$$&#39;</span>
<span class="n">cdffig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text</span><span class="si">{Pr}</span><span class="s1">(x\leq X)$$&#39;</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layout</span> <span class="o">=</span> <span class="n">gridplot</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">350</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">linear_cmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColorBar</span><span class="p">,</span> <span class="n">ColumnDataSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.layouts</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridplot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.palettes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Viridis256</span><span class="p">,</span> <span class="n">gray</span><span class="p">,</span> <span class="n">magma</span><span class="p">,</span> <span class="n">Category20</span>

<span class="c1"># Convert the nested dict into a DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_r2_dict</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose to get priors as columns</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Prior&#39;</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Bitrate&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Melt the DataFrame to a long format</span>
<span class="n">df_melted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;Prior&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Bitrate&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
<span class="c1"># Ensure the Bitrate values are ordered correctly (increasing order)</span>
<span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;Bitrate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;Bitrate&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;Bitrate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># Create a Bokeh ColumnDataSource</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">df_melted</span><span class="p">)</span>

<span class="c1"># Create a figure for the heatmap</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;KL divergence from attributes: R² of test set by Prior and Bitrate&quot;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
           <span class="n">tools</span><span class="o">=</span><span class="s2">&quot;hover&quot;</span><span class="p">,</span> <span class="n">tooltips</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="s1">&#39;@Value</span><span class="si">{0.00}</span><span class="s1">&#39;</span><span class="p">)],</span> <span class="n">toolbar_location</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Create a color mapper</span>
<span class="n">mapper</span> <span class="o">=</span> <span class="n">linear_cmap</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">magma</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">low</span><span class="o">=</span><span class="n">df_melted</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">df_melted</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="c1"># Add rectangles to the plot</span>
<span class="n">p</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Prior&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Bitrate&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
       <span class="n">line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="n">mapper</span><span class="p">)</span>

<span class="c1"># Add color bar</span>
<span class="n">color_bar</span> <span class="o">=</span> <span class="n">ColorBar</span><span class="p">(</span><span class="n">color_mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">color_bar</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>

<span class="c1"># Format plot</span>
<span class="n">p</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">axis_line_color</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">p</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">major_tick_line_color</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$Q(θ|D)∼\text</span><span class="si">{Dirichlet}</span><span class="s1">(\alpha = 10^</span><span class="si">{a}</span><span class="s1">)$$&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Quantization Bitrate (dictionary size)}$$&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">major_label_text_font_size</span> <span class="o">=</span> <span class="s2">&quot;10pt&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">major_label_standoff</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">major_label_orientation</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Output the plot to an HTML file and display it</span>
<span class="c1"># output_file(&quot;heatmap.html&quot;)</span>
<span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">#</a></h2>
<p>Since KL divergence <span class="math notranslate nohighlight">\(D_{KL}(P||Q) = \sum_{i=1}^{2^b} p_i\log(\frac{p_i}{q_i}) = +\infty \text{ when any } q_i \rightarrow 0\)</span>, the simulated <span class="math notranslate nohighlight">\(Q\)</span> is treated as a posterior distribution by assuming a uniform (Dirichlet) prior <span class="math notranslate nohighlight">\(\alpha = [a_1, \dots, a_n]\)</span>. The prior <span class="math notranslate nohighlight">\(\alpha\)</span> is an additive array of uniform pseudo-counts used to address the (commonly occurring) case where <span class="math notranslate nohighlight">\(q_i = 0\)</span>, that is the model does not predict an observed state <span class="math notranslate nohighlight">\(i\)</span>.  In this experiment we tested a wide range of priors on an exponential scale, <span class="math notranslate nohighlight">\(\alpha = 10^a, a \in [-2, -1, 0, 1, 2]\)</span>.</p>
<p>The scale of the pseudo-count can be interpreted as a strength of belief in the model. Small <span class="math notranslate nohighlight">\(a\)</span> represents strong belief that the model produces a distribution <span class="math notranslate nohighlight">\(Q\)</span> that is representative of the “true” (observed posterior) distribution <span class="math notranslate nohighlight">\(P\)</span>, and for a fixed <span class="math notranslate nohighlight">\(p_i\)</span> the effect of a decreasing <span class="math notranslate nohighlight">\(a\)</span> on the discriminant function <span class="math notranslate nohighlight">\(D_{KL}\)</span> yields a stronger penalty for a model that predicts an observed state with 0 probability.  Loss functions penalize overconfidence in incorrect predictions, and a prediction of 0 probability of a state which is actually observed should perhaps be thought of as confidence in an incorrect prediction and penalized as such.  A large <span class="math notranslate nohighlight">\(a\)</span> represents weak belief that the model produces a distribution <span class="math notranslate nohighlight">\(Q\)</span> that is representative of <span class="math notranslate nohighlight">\(P\)</span>, since <span class="math notranslate nohighlight">\(Q\)</span> approaches the uniform distribution <span class="math notranslate nohighlight">\(\mathbb{U}\)</span> as <span class="math notranslate nohighlight">\(a\)</span> increases.</p>
<p>Adding pseudo-counts has the effect of diluting the signal for the gradient boosting model to exploit in minimizing prediction error.  Analogously, varying the bitrate, or the size of the dictionary used to quantize continuous streamflow into discrete states, also adds quantization noise since the original streamflow signals are stored in three decimal precision and they are quantized into as few as 4 bits (16 symbol dictionary) and as many as 12 bits (4096 symbol dictionary).  The range of dictionary sizes is set to cover the expected range of rating curve uncertainty, which is generally considered multiplicative and expressed as a % of the observed value.</p>
<p>As shown by the results, priors representing the addition of <span class="math notranslate nohighlight">\(10^1 \text{ to } 10^2\)</span> pseudo-counts diminishes the performance of the gradient boosted decision tree model, regardless of the dictionary size, or the number of possible values provided by the quantization.  Heavily penalizing unpredicted states does not have as great an impact as anticipated, perhaps as a result of the corresponding <span class="math notranslate nohighlight">\(p_i\)</span> values also being small.</p>
<p>How do the prior and the birate affect the distribution of “actual” <span class="math notranslate nohighlight">\(D_{KL}\)</span>?.</p>
</section>
<section id="is-the-distribution-of-values-inflating-the-coefficient-of-determination">
<h2>Is the distribution of values inflating the coefficient of determination?<a class="headerlink" href="#is-the-distribution-of-values-inflating-the-coefficient-of-determination" title="Link to this heading">#</a></h2>
<div class="math notranslate nohighlight">
\[R^2 = 1 - \frac{\sum (y_i - \hat y_i)^2}{\sum (y_i - \bar y_i)^2}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_cdf</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">pcts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">],</span> <span class="n">pcts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">],</span> <span class="n">pcts</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">pcts</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;actual&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">pcts</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;predicted&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># test a bogus R^2 value</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">test_figs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;10^6 low points, 10^</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> high points&#39;</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted&#39;</span><span class="p">])</span>
    <span class="c1"># test_df = np.log10(test_df)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">plot_contour_map</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">test_figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">plot_cdf</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
    <span class="n">test_figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layout</span> <span class="o">=</span> <span class="n">gridplot</span><span class="p">(</span><span class="n">test_figs</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">350</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Link to this heading">#</a></h2>
<span class="target" id="id1"></span></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/ss"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#question-can-we-find-temporal-anomalies-in-pdfs">Question: Can we find temporal anomalies in PDFs?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-import-and-model-setup">Data Import and Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-cluster-numbers-to-stratify-k-fold-validation-clusters">Assign cluster numbers to stratify k-fold validation clusters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-load-the-results-to-avoid-repeat-loads-in-the-model-training-iterations">Pre-load the results to avoid repeat loads in the model training iterations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-cdfs-based-on-support-coverage-flags">Check CDFs based on support coverage flags</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-pairwise-attribute-comparisons">Load pairwise attribute comparisons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-attribute-groupings">Define attribute groupings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regression-problem">Regression Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-trial-parameters">Set trial parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split">Train-Test Split</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-regression-models">Run Regression Models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-results-of-d-kl-regression-test">Plot Results of <span class="math notranslate nohighlight">\(D_{KL}\)</span> Regression Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">Discussion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#is-the-distribution-of-values-inflating-the-coefficient-of-determination">Is the distribution of values inflating the coefficient of determination?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dan Kovacek
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>