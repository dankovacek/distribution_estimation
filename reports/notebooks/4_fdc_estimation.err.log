Traceback (most recent call last):
  File "/home/danbot/code/data_analysis/lib/python3.12/site-packages/jupyter_core/utils/__init__.py", line 154, in wrapped
    asyncio.get_running_loop()
RuntimeError: no running event loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/danbot/code/data_analysis/lib/python3.12/site-packages/jupyter_cache/executors/utils.py", line 58, in single_nb_execution
    executenb(
  File "/home/danbot/code/data_analysis/lib/python3.12/site-packages/nbclient/client.py", line 1319, in execute
    return NotebookClient(nb=nb, resources=resources, km=km, **kwargs).execute()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/danbot/code/data_analysis/lib/python3.12/site-packages/jupyter_core/utils/__init__.py", line 158, in wrapped
    return loop.run_until_complete(inner)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/danbot/code/data_analysis/lib/python3.12/site-packages/nbclient/client.py", line 709, in async_execute
    await self.async_execute_cell(
  File "/home/danbot/code/data_analysis/lib/python3.12/site-packages/nbclient/client.py", line 1062, in async_execute_cell
    await self._check_raise_for_error(cell, cell_index, exec_reply)
  File "/home/danbot/code/data_analysis/lib/python3.12/site-packages/nbclient/client.py", line 918, in _check_raise_for_error
    raise CellExecutionError.from_cell_and_msg(cell, exec_reply_content)
nbclient.exceptions.CellExecutionError: An error occurred while executing the following cell:
------------------
plots = []

range_dict = {
    've': [0, 150],
    'pct_vol_bias': [-150, 75],
    'nse': [0, 1],
    'rmse': [0, 150],
    'kld': [0, 2],
}
for k in [1, 2, 4]:  
    for m in metrics:
    
        metric_cols = [c for c in knn_bootstrap_df.columns if c.startswith(m)]
        all_station_results = knn_bootstrap_df[knn_bootstrap_df['k'] == k][metric_cols + ['official_id']].copy()
         
        p = figure(title=f'{k}NN', width=600, height=400, toolbar_location=None, x_axis_type='log')
        
        # if m == 'nae':
        #     all_station_results = 1 - all_station_results

        lb = all_station_results[f'{m}_2.5'].values
        median = all_station_results[f'{m}_50'].values
        ub = all_station_results[f'{m}_97.5'].values

        knn_df = pd.DataFrame({'lb': sorted(lb), 'median': sorted(median), 'ub': sorted(ub)})
        max_pt = 1
        N = len(lstm_df)
        
        label = m.upper()
        xmin, xmax = 0, 4
        if m == 've':
            label = 'NAE [%]'
            knn_df[['lb', 'median', 'ub']] = 100 * (1 - knn_df[['lb', 'median', 'ub']]) # express as %, 0 is perfect
            knn_df.sort_values(by='median', inplace=True)
            xmin, xmax = 0, 150
        elif m == 'pct_vol_bias':
            label = 'PB [%]'
            knn_df = 100 * knn_df       # express as %, 0 is perfect
            xmin, xmax = -150, 75
        elif m == 'nse':
            label = '1 NSE [-]'
            knn_df[['lb', 'median', 'ub']] = 1 - knn_df[['lb', 'median', 'ub']]         # 1-NSE, 0 is perfect
            # sort by median again
            knn_df.sort_values(by='median', inplace=True)
            xmin, xmax = 0, 1.0
        elif m == 'rmse':
            label = 'RMSE [%]'
            knn_df = 100*(np.exp(knn_df) - 1)       # express as %, 0 is perfect
            xmin, xmax = 0, 150
        elif m == 'kld':
            label = 'KLD [bits/sample]'
            xmin, xmax = 0, 2

        N = len(knn_df)
        knn_df['y'] = (np.arange(N) + 0.5) / N
        source = ColumnDataSource(knn_df)

        # get the parametric data source
        param_src = param_data['PredictedLog'][m]
                
        # CI bars aligned to each medianâ€™s ECDF position
        if len(plots) == 3:
            p.harea(x1='lb', y='y', x2='ub', source=param_src, legend_label='LogNorm 95% CI',
                    color='dodgerblue', alpha=0.5)
            p.step('median', 'y', source=param_src, mode='after', line_width=2, color='navy', legend_label='LogNorm Median')
            p.harea(x1='lb', y='y', x2='ub', source=source, legend_label='kNN 95% CI',
                    color='orange', alpha=0.5)
            p.step('median', 'y', source=source, mode='after', line_width=2, color='darkorange', legend_label='kNN Median')
            p.legend.location = 'bottom_right'
            p.legend.background_fill_alpha = 0.5
        else:
            p.harea(x1='lb', y='y', x2='ub', source=param_src, 
                    color='dodgerblue', alpha=0.5)
            p.step('median', 'y', source=param_src, mode='after', line_width=2, color='navy')
            p.harea(x1='lb', y='y', x2='ub', source=source,                    
                    color='orange', alpha=0.5)
            p.step('median', 'y', source=source, mode='after', line_width=2, color='darkorange')


        p = dpf.format_fig_fonts(p, font_size=14)
        if len(plots) >= 8:
            p.xaxis.axis_label = label
        if len(plots) % 4 == 0:
            p.yaxis.axis_label = 'Cumulative Density'
        plots.append(p)

lt = gridplot(plots, ncols=4, width=350, height=300, toolbar_location=None)
fname = f'knn_bootstrap_uncertainty'
dpf.save_fig(lt, fname)
show(lt)
------------------


[31m---------------------------------------------------------------------------[39m
[31mNameError[39m                                 Traceback (most recent call last)
[36mCell[39m[36m [39m[32mIn[36][39m[32m, line 13[39m
[32m     10[39m [38;5;28;01mfor[39;00m k [38;5;129;01min[39;00m [[32m1[39m, [32m2[39m, [32m4[39m]:  
[32m     11[39m     [38;5;28;01mfor[39;00m m [38;5;129;01min[39;00m metrics:
[32m---> [39m[32m13[39m         metric_cols = [c [38;5;28;01mfor[39;00m c [38;5;129;01min[39;00m [43mknn_bootstrap_df[49m.columns [38;5;28;01mif[39;00m c.startswith(m)]
[32m     14[39m         all_station_results = knn_bootstrap_df[knn_bootstrap_df[[33m'[39m[33mk[39m[33m'[39m] == k][metric_cols + [[33m'[39m[33mofficial_id[39m[33m'[39m]].copy()
[32m     16[39m         p = figure(title=[33mf[39m[33m'[39m[38;5;132;01m{[39;00mk[38;5;132;01m}[39;00m[33mNN[39m[33m'[39m, width=[32m600[39m, height=[32m400[39m, toolbar_location=[38;5;28;01mNone[39;00m, x_axis_type=[33m'[39m[33mlog[39m[33m'[39m)

[31mNameError[39m: name 'knn_bootstrap_df' is not defined

