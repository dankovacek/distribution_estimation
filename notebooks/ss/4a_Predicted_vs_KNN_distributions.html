
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Predicted vs. Empricial Distribution Fitting &#8212; Streamflow Distribution Estimation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/ss/4a_Predicted_vs_KNN_distributions';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Streamflow Distribution Estimation - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Streamflow Distribution Estimation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../1_data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Methods.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_Predict_Runoff_Statistics.html">Predict Runoff Statistics from Catchment Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_FDC_Estimation.html">Non-Parametric Simulation</a></li>


<li class="toctree-l1"><a class="reference internal" href="../6_Large_Sample_Results_Comparison.html">Notes</a></li>




</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_estimation" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dankovacek/divergence_estimation/issues/new?title=Issue%20on%20page%20%2Fnotebooks/ss/4a_Predicted_vs_KNN_distributions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/ss/4a_Predicted_vs_KNN_distributions.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Predicted vs. Empricial Distribution Fitting</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#question-what-is-the-best-general-approach-to-estimate-the-pdf-at-an-ungauged-location">Question: What is the best general approach to estimate the PDF at an ungauged location?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-import-and-model-setup">Data Import and Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-knn-distribution-estimation">Perform KNN distribution estimation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="predicted-vs-empricial-distribution-fitting">
<h1>Predicted vs. Empricial Distribution Fitting<a class="headerlink" href="#predicted-vs-empricial-distribution-fitting" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<section id="question-what-is-the-best-general-approach-to-estimate-the-pdf-at-an-ungauged-location">
<h3>Question: What is the best general approach to estimate the PDF at an ungauged location?<a class="headerlink" href="#question-what-is-the-best-general-approach-to-estimate-the-pdf-at-an-ungauged-location" title="Link to this heading">#</a></h3>
<p>We test several methods of estimating flow duration curves for ungauged locations:</p>
<ol class="arabic simple">
<li><p>k-Nearest neighbours, frequency and time averaging.  Equal weighting, inverse distance weighting, and catchment similarity weighting.</p></li>
</ol>
<p>We know that mean annual runoff can be predicted with reasonable accuracy from catchment attributes.  We also know that mean runoff and variance are correlated.  Runoff is generally best approximated by a lognormal distribution among parametric distributions, but the lognormal distribution parameters cannot be computed explicitly from the sample mean and variance.  However, the parameters can be estimated by method of moments, with some penalty over maximum likelihood estimation.  While the mean and variance (and even the log-mean) are predictable from catchment attributes, log-variance is not.  The question this experiment asks is whether the poor predictability of the log-variance results in worse estimation of runoff distribution than the method of moments approximation.</p>
<ol class="arabic simple" start="2">
<li><p>Parametric estimation: predicting lognormal distribution parameters from catchment attributes by a) method of moments on predicted mean and variance, and b) predicting maximum likelihood parameters predicted from catchment attributes.</p></li>
</ol>
<p>We predicted mean and SD based on catchment attributes alone.  We then computed the KL divergence of the predicted (proxy) parametric distributions from KDE fits of target catchment distributions.  We then tested the predictability of these KL divergences from attributes, both individually and in pairs. Individually we tested catchment attributes for the predictability of divergence between the predicted parametric distributions and the (error model) adjusted KDE fits.  Pairwise we tested the predictability of divergence between a predicted parametric distribution of a potential proxy model and an (error model) adjusted KDE fit.</p>
<p>Here we generate distribution estimates from k-nearest neighbours (KNN), where k = 1, …, 10.  Finally, for each simulated location, we compare all methods of estimating distributions:</p>
<ol class="arabic simple">
<li><p><strong>Parametric</strong>: log-normal distributions estimated from predicting mean runoff from catchment attributes, plus the linear approximation between mean and standard deviation runoff.</p></li>
<li><p><strong>KNN</strong>: For each location we approximate a distribution using 1, …, 10 nearest neighbours by:</p>
<ul class="simple">
<li><p>equal weighting (EW)</p></li>
<li><p>inverse-distance weighting (IDW)</p></li>
<li><p>catchment similarity weighting (CSW)</p></li>
</ul>
</li>
<li><p>Find the most similar distribution in the monitoring network:</p>
<ul class="simple">
<li><p>by Kullback-Leibler, Wasserstein, TVD, Hellinger distance</p></li>
<li><p>record the distance ranks of the neighbouring distributions</p></li>
<li><p>think about how to address how stable the rankings are under different assumptions, i.e. priors</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="data-import-and-model-setup">
<h2>Data Import and Model Setup<a class="headerlink" href="#data-import-and-model-setup" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xyzservices.providers</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xyz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.layouts</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridplot</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">factor_cmap</span><span class="p">,</span> <span class="n">linear_cmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">LinearAxis</span><span class="p">,</span> <span class="n">Range1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">output_notebook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.palettes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sunset10</span><span class="p">,</span> <span class="n">Vibrant7</span><span class="p">,</span> <span class="n">Category20</span><span class="p">,</span> <span class="n">Bokeh6</span><span class="p">,</span> <span class="n">Bokeh7</span><span class="p">,</span> <span class="n">Bokeh8</span><span class="p">,</span> <span class="n">Greys256</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">config_context</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgglomerativeClustering</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">root_mean_squared_error</span><span class="p">,</span>
    <span class="n">mean_absolute_error</span><span class="p">,</span>
    <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span>
    <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">confusion_matrix</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">linregress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">rdist</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">kl_div</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax.scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span> <span class="k">as</span> <span class="n">jkde</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">jax_config</span>
<span class="n">jax_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">vmap</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">KDEpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFTKDE</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">data_processing_functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dpf</span>

<span class="c1"># from sklearn.model_selection import StratifiedKFold</span>
<span class="n">output_notebook</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">46</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span> <span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">vmap</span>
<span class="ne">---&gt; </span><span class="mi">46</span> <span class="kn">from</span><span class="w"> </span><span class="nn">KDEpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFTKDE</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="kn">import</span><span class="w"> </span><span class="nn">data_processing_functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dpf</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span> <span class="c1"># from sklearn.model_selection import StratifiedKFold</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;KDEpy&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">tiles</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;USGS&#39;</span><span class="p">][</span><span class="s1">&#39;USTopo&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the catchment characteristics</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;BCUB_watershed_attributes_updated.csv&#39;</span>
<span class="n">attr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
<span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;log_drainage_area_km2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">])</span>
<span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;tmean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;tmin&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
<span class="n">station_ids</span> <span class="o">=</span> <span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">station_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> monitored basins in the attribute set.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 1325 monitored basins in the attribute set.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the lognormal fit parameter results</span>
<span class="n">ln_fit_fname</span> <span class="o">=</span> <span class="s1">&#39;LN_fit_method_comparison_20250128.csv&#39;</span>
<span class="n">ln_fit_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="n">ln_fit_fname</span><span class="p">)</span>
<span class="n">ln_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ln_fit_fpath</span><span class="p">)</span>

<span class="n">ln_df</span> <span class="o">=</span> <span class="n">ln_df</span><span class="p">[</span><span class="n">ln_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
<span class="n">ln_df</span><span class="p">[</span><span class="s1">&#39;mean_runoff_mm_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ln_df</span><span class="p">[</span><span class="s1">&#39;mean_uar&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">3.6</span> <span class="o">/</span> <span class="mi">1000</span>
<span class="n">ln_df</span><span class="p">[</span><span class="s1">&#39;sd_runoff_mm_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ln_df</span><span class="p">[</span><span class="s1">&#39;sd_uar&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">3.6</span> <span class="o">/</span> <span class="mi">1000</span>

<span class="n">target_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ln_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
    <span class="c1"># create a dict of the</span>
    <span class="n">target_dict</span> <span class="o">=</span> <span class="n">ln_df</span><span class="p">[[</span><span class="s1">&#39;official_id&#39;</span><span class="p">,</span> <span class="n">tc</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">tc</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">attr_df</span><span class="p">[</span><span class="n">tc</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">target_dict</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># open an example pairwise results file</span>
<span class="n">input_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;processed_divergence_inputs&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">pairs_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_folder</span><span class="p">)</span>
<span class="n">rev_date</span> <span class="o">=</span> <span class="s1">&#39;20250119&#39;</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># parametric_df = pd.read_csv(os.path.join(input_folder, f&#39;MEMBAKDE_results_{rev_date}.csv&#39;), nrows=n_rows)</span>
<span class="c1"># parametric_df.head()</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;Results_estimated_vs_observed_LN_fits_20250118.csv&#39;</span>
<span class="n">bootstrap_result_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;parametric_fits&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
<span class="n">param_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">bootstrap_result_fpath</span><span class="p">)</span>
<span class="n">param_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">param_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>official_id</th>
      <th>obs_mean_mm_day</th>
      <th>obs_std</th>
      <th>pred_mean_mm_day</th>
      <th>pred_sigma</th>
      <th>KL_KDE_AKDE_2.5</th>
      <th>KL_KDE_AKDE_50</th>
      <th>KL_KDE_AKDE_97.5</th>
      <th>KL_AKDE_LNobs_2.5</th>
      <th>KL_AKDE_LNobs_50</th>
      <th>KL_AKDE_LNobs_97.5</th>
      <th>KL_AKDE_LNest_2.5</th>
      <th>KL_AKDE_LNest_50</th>
      <th>KL_AKDE_LNest_97.5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>05AA023</td>
      <td>0.763394</td>
      <td>1.286813</td>
      <td>0.821331</td>
      <td>1.201441</td>
      <td>0.004435</td>
      <td>0.006690</td>
      <td>0.011342</td>
      <td>1.026485</td>
      <td>1.044057</td>
      <td>1.065971</td>
      <td>0.700195</td>
      <td>0.715953</td>
      <td>0.735906</td>
    </tr>
    <tr>
      <th>1</th>
      <td>05AA035</td>
      <td>0.772076</td>
      <td>1.449857</td>
      <td>0.662123</td>
      <td>1.017802</td>
      <td>0.021181</td>
      <td>0.029060</td>
      <td>0.043829</td>
      <td>0.687753</td>
      <td>0.749125</td>
      <td>0.806108</td>
      <td>0.678864</td>
      <td>0.744101</td>
      <td>0.802399</td>
    </tr>
    <tr>
      <th>2</th>
      <td>05AD033</td>
      <td>4.073865</td>
      <td>5.079821</td>
      <td>3.869882</td>
      <td>4.717802</td>
      <td>0.039788</td>
      <td>0.053163</td>
      <td>0.073777</td>
      <td>0.698456</td>
      <td>0.783050</td>
      <td>0.865009</td>
      <td>0.741019</td>
      <td>0.827571</td>
      <td>0.912939</td>
    </tr>
    <tr>
      <th>3</th>
      <td>05BF017</td>
      <td>1.162493</td>
      <td>1.957323</td>
      <td>1.481970</td>
      <td>1.963457</td>
      <td>2.081178</td>
      <td>2.130511</td>
      <td>2.189047</td>
      <td>0.864798</td>
      <td>0.900978</td>
      <td>0.940367</td>
      <td>0.476573</td>
      <td>0.506467</td>
      <td>0.536577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>05BJ010</td>
      <td>0.821697</td>
      <td>1.169613</td>
      <td>0.695347</td>
      <td>1.056124</td>
      <td>0.011753</td>
      <td>0.021304</td>
      <td>0.038843</td>
      <td>1.333488</td>
      <td>1.355958</td>
      <td>1.382492</td>
      <td>1.697818</td>
      <td>1.721834</td>
      <td>1.752463</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a dict of &#39;official_id&#39;: &#39;drainage area&#39;</span>
<span class="n">da_dict</span> <span class="o">=</span> <span class="n">attr_df</span><span class="p">[[</span><span class="s1">&#39;official_id&#39;</span><span class="p">,</span> <span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">centroids</span> <span class="o">=</span> <span class="n">attr_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;centroid_lon_deg_e&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;centroid_lat_deg_n&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">attr_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">attr_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
<span class="n">attr_gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;unnamed: 0&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">attr_gdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># convert to BC Albers for computing distances</span>
<span class="n">attr_gdf</span> <span class="o">=</span> <span class="n">attr_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3005</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># preload the FFT KDE fit results (note these are not &quot;error adapted&quot;</span>
<span class="n">kde_file</span> <span class="o">=</span> <span class="s1">&#39;KL_fft_kde_fits_20241226.csv&#39;</span>
<span class="n">kde_fit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;parametric_divergence_test&#39;</span><span class="p">,</span> <span class="n">kde_file</span><span class="p">))</span>
<span class="n">unique_proxies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kde_fit_df</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">unique_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kde_fit_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_proxies</span><span class="p">)</span><span class="si">}</span><span class="s1"> unique proxies, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_targets</span><span class="p">)</span><span class="si">}</span><span class="s1"> unique targets&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1323 unique proxies, 1324 unique targets
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the predicted parameter results</span>
<span class="n">predict_result_folder</span> <span class="o">=</span> <span class="s1">&#39;/home/danbot2/code_5820/24/divergence_measures/docs/notebooks/data/prediction_results/runoff_prediction_results&#39;</span>
<span class="n">best_result_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">predict_result_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;best_&#39;</span><span class="p">)]</span>
<span class="n">predicted_params</span><span class="p">,</span> <span class="n">best_result_dfs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">best_result_files</span><span class="p">:</span>
    <span class="n">param</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">rdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predict_result_folder</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;official_id&#39;</span><span class="p">)</span>
    <span class="n">rdf</span> <span class="o">=</span> <span class="n">rdf</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rdf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Unnamed:&#39;</span><span class="p">)]]</span>
    <span class="n">rdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">rdf</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">best_result_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdf</span><span class="p">)</span>
    <span class="n">predicted_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    
<span class="c1"># predicted_params = [&#39;LN_MMO_mu_hat&#39;, &#39;LN_MMO_sd_hat&#39;, &#39;mean_logx&#39;, &#39;sd_logx&#39;]</span>
<span class="n">predicted_param_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">best_result_dfs</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">predicted_param_dict</span> <span class="o">=</span> <span class="n">predicted_param_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="perform-knn-distribution-estimation">
<h2>Perform KNN distribution estimation<a class="headerlink" href="#perform-knn-distribution-estimation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">cKDTree</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">geom</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">attr_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">])</span>
<span class="n">stn_tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

<span class="c1"># Create mapping from official_id to index</span>
<span class="n">id_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">oid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attr_gdf</span><span class="p">[</span><span class="s2">&quot;official_id&quot;</span><span class="p">])}</span>
<span class="n">index_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">oid</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">id_to_index</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>  <span class="c1"># Reverse mapping</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="c1"># Extract values (excluding &#39;official_id&#39; since it&#39;s categorical)</span>
<span class="n">attribute_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;log_drainage_area_km2&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation_m&#39;</span><span class="p">,</span> <span class="s1">&#39;prcp&#39;</span><span class="p">,</span> <span class="s1">&#39;tmean&#39;</span><span class="p">,</span> <span class="s1">&#39;swe&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;land_use_forest_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_snow_ice_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_water_frac_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;land_use_wetland_frac_2010&#39;</span><span class="p">]</span>
<span class="n">attr_gdf</span><span class="p">[</span><span class="s1">&#39;log_drainage_area_km2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">attr_gdf</span><span class="p">[</span><span class="s1">&#39;drainage_area_km2&#39;</span><span class="p">])</span>
<span class="n">attr_values</span> <span class="o">=</span> <span class="n">attr_gdf</span><span class="p">[</span><span class="n">attribute_columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">normalized_attr_values</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">attr_values</span><span class="p">)</span>
<span class="c1"># Convert normalized distances back to original units</span>
<span class="n">std_devs_attrs</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">scale_</span>  <span class="c1"># Standard deviation of each feature</span>

<span class="n">attr_tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">normalized_attr_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_lognorm_pmf</span><span class="p">(</span><span class="n">log_x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">integral_tol</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">):</span>
    <span class="c1"># Lognormal parameters</span>
    <span class="n">norm_pdf</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">log_x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
    <span class="n">norm_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">norm_pdf</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">log_x</span><span class="p">)</span>
    <span class="n">lin_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_x</span><span class="p">)</span>
    <span class="n">norm_lin_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">norm_pdf</span> <span class="o">/</span> <span class="n">lin_grid</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">lin_grid</span><span class="p">)</span> 
    <span class="n">nc1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">norm_check</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">integral_tol</span><span class="p">)</span><span class="c1">#, norm_check</span>
    <span class="n">nc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">norm_lin_check</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">integral_tol</span><span class="p">)</span><span class="c1">#, norm_lin_check</span>
    <span class="c1"># print(f&#39;Norm integral: {norm_check:.4f}&#39;)</span>
    
    <span class="n">norm_cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">norm_pdf</span><span class="p">)</span>
    <span class="n">norm_cdf</span> <span class="o">/=</span> <span class="n">norm_cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm_pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">norm_cdf</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm_pmf</span><span class="p">,</span> <span class="n">norm_pdf</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the ranges and associated errors</span>
<span class="n">error_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e7</span><span class="p">])</span>  <span class="c1"># Magnitude points in L/s/km^2</span>
<span class="n">error_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">])</span>    <span class="c1"># Associated errors (as proportions)</span>

<span class="n">efig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Estimated Measurement Error Model&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">efig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">error_points</span><span class="p">,</span> <span class="n">error_values</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;Measurement Error Model&#39;</span><span class="p">)</span>
<span class="n">efig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Unit Area Runoff }L s^{-1} \text</span><span class="si">{km}</span><span class="s1">^{-2}$$&#39;</span>
<span class="n">efig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Error } [\text</span><span class="si">{x}</span><span class="s1">100\%]$$&#39;</span>
<span class="n">efig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">efig</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">efig</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">efig</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">efig</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">layout</span> <span class="o">=</span> <span class="n">gridplot</span><span class="p">([</span><span class="n">efig</span><span class="p">],</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">350</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="ef627a79-7dc8-4082-a0b7-ce7fd849efee" data-root-id="p1054" style="display: contents;"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
  const docs_json = {"21539a5d-d73b-4448-a203-4bc769536054":{"version":"3.6.0","title":"Bokeh Application","roots":[{"type":"object","name":"GridPlot","id":"p1054","attributes":{"rows":null,"cols":null,"toolbar":{"type":"object","name":"Toolbar","id":"p1053","attributes":{"tools":[{"type":"object","name":"ToolProxy","id":"p1047","attributes":{"tools":[{"type":"object","name":"PanTool","id":"p1023"}]}},{"type":"object","name":"ToolProxy","id":"p1048","attributes":{"tools":[{"type":"object","name":"WheelZoomTool","id":"p1024","attributes":{"renderers":"auto"}}]}},{"type":"object","name":"ToolProxy","id":"p1049","attributes":{"tools":[{"type":"object","name":"BoxZoomTool","id":"p1025","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1026","attributes":{"syncable":false,"line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5,"level":"overlay","visible":false,"left":{"type":"number","value":"nan"},"right":{"type":"number","value":"nan"},"top":{"type":"number","value":"nan"},"bottom":{"type":"number","value":"nan"},"left_units":"canvas","right_units":"canvas","top_units":"canvas","bottom_units":"canvas","handles":{"type":"object","name":"BoxInteractionHandles","id":"p1032","attributes":{"all":{"type":"object","name":"AreaVisuals","id":"p1031","attributes":{"fill_color":"white","hover_fill_color":"lightgray"}}}}}}}}]}},{"type":"object","name":"SaveTool","id":"p1050"},{"type":"object","name":"ToolProxy","id":"p1051","attributes":{"tools":[{"type":"object","name":"ResetTool","id":"p1034"}]}},{"type":"object","name":"ToolProxy","id":"p1052","attributes":{"tools":[{"type":"object","name":"HelpTool","id":"p1035"}]}}]}},"children":[[{"type":"object","name":"Figure","id":"p1001","attributes":{"width":500,"height":350,"x_range":{"type":"object","name":"DataRange1d","id":"p1002"},"y_range":{"type":"object","name":"DataRange1d","id":"p1003"},"x_scale":{"type":"object","name":"LogScale","id":"p1011"},"y_scale":{"type":"object","name":"LinearScale","id":"p1012"},"title":{"type":"object","name":"Title","id":"p1004","attributes":{"text":"Estimated Measurement Error Model"}},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1042","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1036","attributes":{"selected":{"type":"object","name":"Selection","id":"p1037","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1038"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"exSuR+F6hD+amZmZmZm5PwAAAAAAAPA/AAAAAAAAJEAAAAAAAABZQAAAAAAAQI9AAAAAAACIw0AAAAAAAGr4QAAAAACAhC5BAAAAANASY0E="},"shape":[10],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"AAAAAAAA8D8AAAAAAADgPwAAAAAAANA/MzMzMzMzwz+amZmZmZm5P5qZmZmZmbk/mpmZmZmZuT8zMzMzMzPDP5qZmZmZmck/AAAAAAAA0D8="},"shape":[10],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1043","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1044"}}},"glyph":{"type":"object","name":"Line","id":"p1039","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_width":2}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1040","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.1,"line_width":2}},"muted_glyph":{"type":"object","name":"Line","id":"p1041","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"red","line_alpha":0.2,"line_width":2}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1010","attributes":{"tools":[{"id":"p1023"},{"id":"p1024"},{"id":"p1025"},{"type":"object","name":"SaveTool","id":"p1033"},{"id":"p1034"},{"id":"p1035"}]}},"toolbar_location":null,"left":[{"type":"object","name":"LinearAxis","id":"p1018","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1019","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1020"},"axis_label":"$$\\text{Error } [\\text{x}100\\%]$$","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"12pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1021"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"10pt"}}],"below":[{"type":"object","name":"LogAxis","id":"p1013","attributes":{"ticker":{"type":"object","name":"LogTicker","id":"p1014","attributes":{"num_minor_ticks":10,"mantissas":[1,5]}},"formatter":{"type":"object","name":"LogTickFormatter","id":"p1015"},"axis_label":"$$\\text{Unit Area Runoff }L s^{-1} \\text{km}^{-2}$$","axis_label_text_font":"Bitstream Charter","axis_label_text_font_size":"12pt","major_label_policy":{"type":"object","name":"AllLabels","id":"p1016"},"major_label_text_font":"Bitstream Charter","major_label_text_font_size":"10pt"}}],"center":[{"type":"object","name":"Grid","id":"p1017","attributes":{"axis":{"id":"p1013"}}},{"type":"object","name":"Grid","id":"p1022","attributes":{"dimension":1,"axis":{"id":"p1018"}}},{"type":"object","name":"Legend","id":"p1045","attributes":{"background_fill_alpha":0.5,"label_text_font":"Bitstream Charter","label_text_font_size":"10pt","items":[{"type":"object","name":"LegendItem","id":"p1046","attributes":{"label":{"type":"value","value":"Measurement Error Model"},"renderers":[{"id":"p1042"}]}}]}}]}},0,0]]}}]}};
  const render_items = [{"docid":"21539a5d-d73b-4448-a203-4bc769536054","roots":{"p1054":"ef627a79-7dc8-4082-a0b7-ce7fd849efee"},"root_ids":["p1054"]}];
  void root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">check_support_coverage</span><span class="p">(</span><span class="n">baseline_pmf</span><span class="p">,</span> <span class="n">proxy_distribution</span><span class="p">):</span>
    <span class="c1"># find the total mass of the KDE baseline distribution</span>
    <span class="c1"># where the proxy distribution = 0</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">proxy_distribution</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">unsupported_pmf</span> <span class="o">=</span> <span class="n">baseline_pmf</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">unsupported_pmf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">epanechnikov_kernel</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Epanechnikov kernel: finite support in [-1, 1] &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">top_hat_kernel</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gaussian_kernel</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Gaussian kernel: smooth, infinite support &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_silverman_approx</span><span class="p">(</span><span class="n">log_data</span><span class="p">):</span>
    <span class="n">q75</span><span class="p">,</span> <span class="n">q25</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">log_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">stdev</span><span class="p">,</span> <span class="p">(</span><span class="n">q75</span> <span class="o">-</span> <span class="n">q25</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.34</span><span class="p">])</span>
    <span class="k">return</span> <span class="mf">1.06</span> <span class="o">*</span> <span class="n">A</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span><span class="o">**</span><span class="mf">0.2</span>


<span class="k">def</span><span class="w"> </span><span class="nf">measurement_error_bandwidth_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">error_points</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1e1</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">])</span>  <span class="c1">#  Reference flow points in m^3/s</span>
    <span class="n">error_values</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">])</span>     <span class="c1"># Associated errors (as proportions)</span>
    <span class="c1"># scaling_factor = baseline_h / jnp.min(error_values) </span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">error_points</span><span class="p">,</span> <span class="n">error_values</span><span class="p">)</span> 

  
<span class="k">def</span><span class="w"> </span><span class="nf">compute_measurement_error_informed_adaptive_bandwidth</span><span class="p">(</span><span class="n">uar</span><span class="p">,</span> <span class="n">da</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Compute midpoints in log-space for kernel support boundaries &quot;&quot;&quot;</span>

    <span class="c1"># get the approximated measurement error associated with each unique FLOW value</span>
    <span class="n">flow_data</span> <span class="o">=</span> <span class="n">uar</span> <span class="o">*</span> <span class="n">da</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="n">unique_q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">flow_data</span><span class="p">)</span>
    <span class="n">error_model</span> <span class="o">=</span> <span class="n">measurement_error_bandwidth_function</span><span class="p">(</span><span class="n">unique_q</span><span class="p">)</span>

    <span class="c1"># error widths must be in unit area runoff log space </span>
    <span class="c1"># to align with the precision bandwidth correction</span>
    <span class="c1"># since the KDE is fit to UAR in log space</span>
    <span class="n">unique_UAR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">da</span><span class="p">)</span> <span class="o">*</span> <span class="n">unique_q</span> 
    <span class="n">upper_err_UAR</span> <span class="o">=</span> <span class="n">unique_UAR</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">error_model</span><span class="p">)</span>
    <span class="n">err_widths_UAR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">upper_err_UAR</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">unique_UAR</span><span class="p">)</span>
    
    <span class="c1"># define bounds for support based on neighbouring unique values</span>
    <span class="c1"># Compute midpoints between adjacent log_values</span>
    <span class="n">log_midpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">unique_UAR</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">unique_UAR</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Midpoints of internal values</span>
    <span class="c1"># Compute left and right extensions by mirroring end widths</span>
    <span class="n">left_mirror</span> <span class="o">=</span> <span class="n">unique_UAR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">log_midpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">unique_UAR</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">right_mirror</span> <span class="o">=</span> <span class="n">unique_UAR</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">unique_UAR</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_midpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Prepend and append mirrored values</span>
    <span class="n">log_midpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">left_mirror</span><span class="p">]),</span> <span class="n">log_midpoints</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">right_mirror</span><span class="p">])))</span>
    <span class="c1"># the error distance is half the interval, </span>
    <span class="c1"># then divide by a z-score to represent the proportion of probability mass</span>
    <span class="c1"># falling within the range of the midpoints between unique values</span>
    <span class="n">log_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">log_midpoints</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">1.15</span>
    
    <span class="c1"># integrate where the precision gaps yield larger values than the assumed error</span>
    <span class="c1"># bw_vals = np.where(log_diffs &gt; err_widths, log_diffs, err_widths)</span>
    <span class="n">bw_vals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">log_diffs</span> <span class="o">&gt;</span> <span class="n">err_widths_UAR</span><span class="p">,</span> <span class="n">log_diffs</span><span class="p">,</span> <span class="n">err_widths_UAR</span><span class="p">)</span>
    <span class="c1"># just for interest&#39;s sake, find where the precision dominates the error model</span>
    <span class="c1"># foo = np.sum(np.where(log_diffs &gt; err_widths, 1, 0))</span>
    <span class="c1"># print(f&#39;    ...precision width dominates: {foo}/{len(values)} cases&#39;)</span>
    <span class="c1"># broadcast the adaptive bandwidth values to the input timeseries</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">unique_UAR</span><span class="p">,</span> <span class="n">uar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bw_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">adaptive_kde</span><span class="p">(</span><span class="n">uar_data</span><span class="p">,</span> <span class="n">log_grid</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">estimated_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdf_error_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">min_allowable_bandwidth</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
    
    <span class="n">eval_grid</span> <span class="o">=</span> <span class="n">estimated_grid</span> <span class="k">if</span> <span class="n">estimated_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">log_grid</span>
    
    <span class="c1"># compute bandwidths according to a measurement error model</span>
    <span class="c1"># incorporating a test for precision vestiges</span>
    <span class="n">bw_values</span> <span class="o">=</span> <span class="n">compute_measurement_error_informed_adaptive_bandwidth</span><span class="p">(</span><span class="n">uar_data</span><span class="p">,</span> <span class="n">da</span><span class="p">)</span>  <span class="c1"># Compute adaptive bandwidth per point</span>

    <span class="c1"># Expand dimensions: Tile data and bandwidths for matrix operation</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uar_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_grid</span><span class="p">)</span>
    <span class="n">log_data</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">uar_data</span><span class="p">)</span>
    <span class="n">X_grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">eval_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Shape: (N, M)</span>
    <span class="n">X_data</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">log_data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>  <span class="c1"># Shape: (N, M)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">bw_values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>  <span class="c1"># Shape: (N, M)</span>

    <span class="c1"># Compute u matrix: (N, M)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_grid</span> <span class="o">-</span> <span class="n">X_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">H</span>

    <span class="c1"># Apply Epanechnikov kernel (element-wise)</span>
    <span class="c1"># K = epanechnikov_kernel(U) / H  # Scale kernel contributions</span>
    <span class="c1"># K = top_hat_kernel(U) / H</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">gaussian_kernel</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="o">/</span> <span class="n">H</span>

    <span class="c1"># Sum contributions across observations</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>  <span class="c1"># Normalize by sample count</span>
    <span class="n">pdf_check</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">eval_grid</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">/=</span> <span class="n">pdf_check</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pdf_check</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">eval_grid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pdf_error_tol</span><span class="p">,</span> <span class="s2">&quot;PDF does not integrate to 1 in adaptive_kde()&quot;</span>
        
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">/=</span> <span class="n">cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># If estimated_grid is used, interpolate PMF onto log_grid</span>
    <span class="k">if</span> <span class="n">estimated_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pmf_interp</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">log_grid</span><span class="p">,</span> <span class="n">estimated_grid</span><span class="p">,</span> <span class="n">pmf</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="c1">#, kind=&#39;linear&#39;, bounds_error=False, fill_value=(0, 0))</span>
        <span class="c1"># pmf_interp = interp_func(log_grid)</span>
        <span class="n">pmf_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pmf_interp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pmf_interp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Do not normalize here, leave unsupported probability mass out</span>
        <span class="k">return</span> <span class="n">pmf_interp</span><span class="p">,</span> <span class="n">pdf</span>

    <span class="n">pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pmf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pmf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pmf</span><span class="p">,</span> <span class="n">pdf</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">single_kde_fit</span><span class="p">(</span><span class="n">log_data</span><span class="p">,</span> <span class="n">log_grid</span><span class="p">):</span>
    <span class="n">kde_pdf</span> <span class="o">=</span> <span class="n">FFTKDE</span><span class="p">(</span><span class="n">bw</span><span class="o">=</span><span class="s1">&#39;ISJ&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">log_grid</span><span class="p">)</span>
    <span class="c1"># Extract the estimated bandwidth</span>
    <span class="n">pdf_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">kde_pdf</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">log_grid</span><span class="p">)</span>
    <span class="n">kde_pdf</span> <span class="o">/=</span> <span class="n">pdf_check</span>
    <span class="c1"># check that the numerical integration over the KDE pdf is close to 1</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">pdf_check</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pdf_check</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">kde_pdf</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">kde_pdf</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="c1"># pdfs[:, i] = sample_pdf</span>
    <span class="n">kde_cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">kde_pdf</span><span class="p">)</span>
    <span class="n">kde_cdf</span> <span class="o">/=</span> <span class="n">kde_cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">kde_pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">kde_cdf</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kde_pmf</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.001</span>
    <span class="k">return</span> <span class="n">kde_pmf</span><span class="p">,</span> <span class="n">kde_pdf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_similarity_weights</span><span class="p">(</span><span class="n">stns</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">,</span> <span class="s1">&#39;log_drainage_area_km2&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation_m&#39;</span><span class="p">,</span> <span class="s1">&#39;prcp&#39;</span><span class="p">,</span> <span class="s1">&#39;tmean&#39;</span><span class="p">,</span> <span class="s1">&#39;swe&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attr_df</span><span class="p">[</span><span class="n">attr_df</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">stns</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">])][</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;official_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stns</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="c1"># make sure the official id order is maintained so the weights are properly assigned</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">stns</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;official_id&#39;</span><span class="p">]]</span>
    <span class="c1"># normalize weights first within column, then equally along rows</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">attrs</span> <span class="o">-</span> <span class="n">attrs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">attrs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">normalized_similarity</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">normalized_similarity</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_k_nearest_neighbors</span><span class="p">(</span><span class="n">target_index</span><span class="p">,</span> <span class="n">tree_type</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># Query the k+1 nearest neighbors because the first neighbor is the target point itself</span>
    <span class="k">if</span> <span class="n">tree_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EW&#39;</span><span class="p">,</span> <span class="s1">&#39;IDW&#39;</span><span class="p">]:</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">stn_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">target_index</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tree_type</span> <span class="o">==</span> <span class="s1">&#39;CAS&#39;</span><span class="p">:</span>
        <span class="c1"># Example query: Find the 3 nearest neighbors for the first point</span>
        <span class="n">distances_norm</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">attr_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">normalized_attr_values</span><span class="p">[</span><span class="n">target_index</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances_norm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">std_devs_attrs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;tree type not identified, must be one of EW, IDW, or CAS.&#39;</span><span class="p">)</span>

    <span class="c1"># Remove the target itself from the results</span>
    <span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">neighbor_distances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">neighbor_indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">neighbor_distances</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">check_neighbours</span><span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">proxy_df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">stn</span><span class="p">)</span>
    <span class="c1"># data.set_index(&#39;time&#39;, inplace=True)</span>
    <span class="n">proxy_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">proxy_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    <span class="n">pct_covered</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">proxy_df</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">pct_covered</span> <span class="o">&gt;=</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">350</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">save</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Div</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.layouts</span><span class="w"> </span><span class="kn">import</span> <span class="n">layout</span>

<span class="k">def</span><span class="w"> </span><span class="nf">output_figure</span><span class="p">(</span><span class="n">target_stn</span><span class="p">,</span> <span class="n">eval_grid</span><span class="p">,</span> <span class="n">log_data</span><span class="p">,</span> <span class="n">predicted_param_dist</span><span class="p">,</span> <span class="n">lognorm_dist</span><span class="p">,</span> <span class="n">mom_ln_dist</span><span class="p">,</span> <span class="n">kde_dist</span><span class="p">,</span> <span class="n">epan_kde_dist</span><span class="p">,</span> <span class="n">best_knn</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">support_dict</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    processing output figure&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_stn</span><span class="si">}</span><span class="s1"> PDF estimation&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">log_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">log_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_edges</span><span class="p">)</span>
    
    <span class="c1"># convert density to mass</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">/=</span> <span class="n">cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pmf</span> <span class="o">/=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;pmf&#39;</span><span class="p">:</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">pmf</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmf</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Histogram sum != 1: </span><span class="si">{</span><span class="n">pmf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">yrs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">top</span><span class="o">=</span><span class="n">hist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Data (N=</span><span class="si">{</span><span class="n">yrs</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> yrs)&#39;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">eval_grid</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">predicted_param_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;Predicted LN Params&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lognorm_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;MLE LogNorm&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mom_ln_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;MOM LogNorm&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kde_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;KDE&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epan_kde_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;EpanKDE&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;EW&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;EW&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;IDW&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;IDW&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;CAS&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;CAS&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;CASdist&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="n">best_knn</span><span class="p">[</span><span class="s1">&#39;CASdist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span><span class="o">=</span><span class="s1">&#39;hide&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Runoff } [Ls^{-1}\text</span><span class="si">{km}</span><span class="s1">^{-2}]$$&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$$\text{Probability Density}$$&#39;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">format_fig_fonts</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">res_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DKL&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>    
    <span class="n">res_table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Model&#39;</span>
    <span class="n">res_table</span> <span class="o">=</span> <span class="n">res_table</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;DKL&#39;</span><span class="p">)</span>
    <span class="n">res_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">min_res</span> <span class="o">=</span> <span class="n">res_table</span><span class="p">[</span><span class="s1">&#39;DKL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">res_table</span><span class="p">[</span><span class="s1">&#39;pct_from_top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">res_table</span><span class="p">[</span><span class="s1">&#39;DKL&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_res</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">suppt_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">support_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unsupported_mass&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">suppt_table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Model&#39;</span>
    <span class="n">suppt_table</span> <span class="o">=</span> <span class="n">suppt_table</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;unsupported_mass&#39;</span><span class="p">)</span>
    <span class="n">suppt_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">top_div</span> <span class="o">=</span> <span class="n">Div</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">res_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">divs</span><span class="p">,</span> <span class="n">sup_tabs</span><span class="p">,</span> <span class="n">param_tabs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">np_models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EW_&#39;</span><span class="p">,</span> <span class="s1">&#39;IDW_&#39;</span><span class="p">,</span> <span class="s1">&#39;CAS_&#39;</span><span class="p">,</span> <span class="s1">&#39;CASdist_&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">np_models</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res_table</span><span class="p">[</span><span class="n">res_table</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">tp</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">Div</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">divs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
        <span class="n">sup</span> <span class="o">=</span> <span class="n">suppt_table</span><span class="p">[</span><span class="n">suppt_table</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">tp</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="n">Div</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">sup</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">sup_tabs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result2</span><span class="p">)</span>
    <span class="n">p_mods</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res_table</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np_models</span><span class="p">)]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res_table</span><span class="p">[</span><span class="n">res_table</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">p_mods</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">tab</span> <span class="o">=</span> <span class="n">Div</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">param_tabs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
        
    <span class="n">lt</span> <span class="o">=</span> <span class="n">layout</span><span class="p">([[</span><span class="n">fig</span><span class="p">],</span> <span class="p">[</span><span class="n">top_div</span><span class="p">,</span> <span class="n">param_tabs</span><span class="p">],</span> <span class="n">divs</span><span class="p">,</span> <span class="n">sup_tabs</span><span class="p">])</span>
    <span class="c1"># show(fig)</span>
    <span class="n">output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_stn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">lt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Experiment</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">k_nearest</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_neighbours_to_check</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">n_grid_points</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">14</span><span class="p">,</span> <span class="n">left_log</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">right_log</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>  
        <span class="n">stn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">official_id</span> <span class="c1"># target catchment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;knn_comparison_plots&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_distribution_prediction.html&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_stn</span> <span class="o">=</span> <span class="n">stn</span>
        <span class="c1"># self.params = {k: v[0] for k, v in ln_df[ln_df[&#39;official_id&#39;] == stn].copy().to_dict(orient=&#39;list&#39;).items()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">predicted_param_dict</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span> 
        
        <span class="c1"># import the streamflow data and do uar and log conversions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stn_df</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">stn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stn_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stn_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_uar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stn_df</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">drainage_area_km2</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">uar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stn_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_uar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_uar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uar</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_grid_points</span> <span class="o">=</span> <span class="n">n_grid_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neighbours_to_check</span> <span class="o">=</span> <span class="n">n_neighbours_to_check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_nearest</span> <span class="o">=</span> <span class="n">k_nearest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_to_id</span> <span class="o">=</span> <span class="n">index_to_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span> <span class="o">=</span> <span class="n">id_to_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">da_dict</span> <span class="o">=</span> <span class="n">da_dict</span>  <span class="c1"># Store drainage areas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_da</span> <span class="o">=</span> <span class="n">da_dict</span><span class="p">[</span><span class="n">stn</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_tree_index</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_nearest_neighbour_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_log</span> <span class="o">=</span> <span class="n">left_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_log</span> <span class="o">=</span> <span class="n">right_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_grid</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...completed initialization.&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_nearest_nbr_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree_type</span><span class="p">):</span>

        <span class="n">neighbour_idxs</span><span class="p">,</span> <span class="n">distances</span> <span class="o">=</span> <span class="n">find_k_nearest_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree_index</span><span class="p">,</span> <span class="n">tree_type</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">n_neighbours_to_check</span><span class="p">)</span>        
        <span class="n">neighbours</span> <span class="o">=</span> <span class="n">attr_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">neighbour_idxs</span><span class="p">][</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># for each proxy, load the MLE and predicted mean and standard deviation from XGBoost model  </span>
        <span class="c1"># checked_neighbours = Parallel(n_jobs=-1, backend=&quot;loky&quot;)(delayed(check_neighbours)(stn, dist, df.copy()) </span>
                                              <span class="c1"># for stn, dist in zip(neighbours, distances))</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>  <span class="c1"># Adjust max workers</span>
            <span class="n">checked_neighbours</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">check_neighbours</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stn_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)))</span>
    
        <span class="n">good_nbrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">checked_neighbours</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_nbrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No suitable nearest neighbours found&#39;</span><span class="p">)</span>
        
        <span class="n">good_nbrs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">good_nbrs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">nbr_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">good_nbrs</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">])</span>
        
        <span class="n">nbr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">good_nbrs</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_found</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_nbrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_found</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_nearest</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_found</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k_nearest</span><span class="si">}</span><span class="s1"> suitable nearest neighbours found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nbr_df</span><span class="p">,</span> <span class="n">nbr_data</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_nearest_neighbour_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    ...searching for minimum </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k_nearest</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_neighbours_to_check</span><span class="si">}</span><span class="s1"> nearest neighbours with minimum concurrent record.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_nearest_nbr_data</span><span class="p">(</span><span class="s1">&#39;EW&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_df_attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_nearest_nbr_data</span><span class="p">(</span><span class="s1">&#39;CAS&#39;</span><span class="p">)</span>
        <span class="c1"># set spatial distance in attribute space dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data_attr</span><span class="p">[</span><span class="s1">&#39;spatial_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data_attr</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_distance</span><span class="p">(</span><span class="n">stn_tree</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_stn</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
        <span class="c1"># set attribute distances in the geographic distance dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data</span><span class="p">[</span><span class="s1">&#39;attr_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_distance</span><span class="p">(</span><span class="n">attr_tree</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_stn</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbr_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbr_data_attr</span><span class="p">)</span>
        

    <span class="k">def</span><span class="w"> </span><span class="nf">set_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span> 
        <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uar</span><span class="p">)</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uar</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">minx</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_log</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">maxx</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grid_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_lin_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">)</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">query_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query distance between two points in a tree using official_id.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">id1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span> <span class="ow">or</span> <span class="n">id2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;One or both IDs (</span><span class="si">{</span><span class="n">id1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">id2</span><span class="si">}</span><span class="s2">) not found.&quot;</span><span class="p">)</span>
    
        <span class="c1"># Get indices from ID mapping</span>
        <span class="n">index1</span><span class="p">,</span> <span class="n">index2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">[</span><span class="n">id1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span>        
        <span class="c1"># Query the distance</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index2</span><span class="p">])</span>  <span class="c1"># Euclidean distance</span>
        <span class="k">return</span> <span class="n">distance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_MLE_lognorm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obs_mean</span><span class="p">,</span> <span class="n">obs_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;actual_mean_logx&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;actual_sd_logx&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lognorm_pmf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lognorm_pdf</span> <span class="o">=</span> <span class="n">compute_lognorm_pmf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">,</span> <span class="n">obs_mean</span><span class="p">,</span> <span class="n">obs_std</span><span class="p">)</span>
        <span class="n">kld</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_kld</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_pmf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lognorm_pmf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;LN_MLE_DKL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kld</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span><span class="p">[</span><span class="s1">&#39;LN_MLE_DKL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span>
        

    <span class="k">def</span><span class="w"> </span><span class="nf">ensemble_distribution_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knn_df</span><span class="p">,</span> <span class="n">ensemble_label</span><span class="p">,</span> <span class="n">distance_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    
        <span class="n">pdfs</span><span class="p">,</span> <span class="n">pmfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">log_knn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">knn_df</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">knn_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">proxy_stn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># print(&#39;proxy stn: &#39;, proxy_stn, da_dict[proxy_stn])</span>
            
            <span class="n">est_min</span><span class="p">,</span> <span class="n">est_max</span> <span class="o">=</span> <span class="n">knn_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">knn_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">est_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">est_min</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_log</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">est_max</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grid_points</span><span class="p">)</span>
            <span class="n">k_pmf</span><span class="p">,</span> <span class="n">k_pdf</span> <span class="o">=</span> <span class="n">adaptive_kde</span><span class="p">(</span><span class="n">knn_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">,</span> <span class="n">da_dict</span><span class="p">[</span><span class="n">proxy_stn</span><span class="p">],</span> <span class="n">estimated_grid</span><span class="o">=</span><span class="n">est_grid</span><span class="p">)</span>
            <span class="n">pmfs</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">pdfs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_pmf</span><span class="p">,</span> <span class="n">k_pdf</span>
        <span class="c1"># print(&#39;distance weights: &#39;, distance_weights)</span>
        <span class="c1"># Normalize distance weights</span>
        <span class="k">if</span> <span class="n">distance_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distance_weights</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">distance_weights</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">distance_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distance_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distance_weights</span><span class="p">)</span>  <span class="c1"># Ensure 1D array</span>
            <span class="n">pdf_est</span> <span class="o">=</span> <span class="n">pdfs</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">@</span> <span class="n">distance_weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdf_est</span> <span class="o">=</span> <span class="n">pdfs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="c1"># Check integral before normalization</span>
        <span class="n">pdf_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pdf_est</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">)</span><span class="c1">#.reshape(-1, 1)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">pdf_check</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
            <span class="n">pdf_est</span> <span class="o">/=</span> <span class="n">pdf_check</span>  <span class="c1"># Only normalize if necessary</span>
    
        <span class="c1"># Compute CDF and PMF</span>
        <span class="n">cdf_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pdf_est</span><span class="p">)</span>
        <span class="n">cdf_est</span> <span class="o">/=</span> <span class="n">cdf_est</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pmf_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf_est</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pmf_est</span><span class="p">,</span> <span class="n">pdf_est</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute normalized inverse distance weights.&quot;&quot;&quot;</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>  <span class="c1"># Prevent division by zero</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">distances</span> <span class="o">**</span> <span class="n">power</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Normalize to sum to 1</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">exclude_col</span><span class="o">=</span><span class="s1">&#39;official_id&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize all columns except `exclude_col` using min-max scaling.&quot;&quot;&quot;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">exclude_col</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">df</span>

            
    <span class="k">def</span><span class="w"> </span><span class="nf">format_knn_pmf_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbrs</span><span class="p">,</span> <span class="n">knn_df</span><span class="p">):</span>
        <span class="c1"># Compute Unit Area Runoff (UAR) for each neighbor</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nbrs</span><span class="p">:</span>
            <span class="n">uar_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">_uar&#39;</span>    
            <span class="n">da</span> <span class="o">=</span> <span class="n">da_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">assert</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
            <span class="n">knn_df</span><span class="p">[</span><span class="n">uar_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">knn_df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">da</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uar_col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">knn_df</span><span class="p">,</span> <span class="n">cols</span>
        
    
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_knn_pmf_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate PMF and PDF using adaptive KDE with optional weights.&quot;&quot;&quot;</span>
        
        <span class="k">assert</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="s1">&#39;dataframe is empty&#39;</span>
        <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;NaN values found in df[cols] before processing&quot;</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weights</span><span class="p">)),</span> <span class="sa">f</span><span class="s1">&#39;nan weight found: </span><span class="si">{</span><span class="n">weights</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;weights do not sum to 1: </span><span class="si">{</span><span class="n">weights</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">weights</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;not all weights &gt; 0, </span><span class="si">{</span><span class="n">weights</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">est_min</span><span class="p">,</span> <span class="n">est_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">est_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">est_min</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_log</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">est_max</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grid_points</span><span class="p">)</span>
    
        <span class="k">assert</span> <span class="p">(</span><span class="n">estimate</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Estimate &lt; 0 detected: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">estimate</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">pmf</span><span class="p">,</span> <span class="n">pdf</span> <span class="o">=</span> <span class="n">adaptive_kde</span><span class="p">(</span><span class="n">estimate</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_da</span><span class="p">,</span> <span class="n">estimated_grid</span><span class="o">=</span><span class="n">est_grid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pmf</span><span class="p">,</span> <span class="n">pdf</span>
        

    <span class="k">def</span><span class="w"> </span><span class="nf">knn_pmf_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate PDF/PMF estimates for the target catchment using kNN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">knn_pmfs</span><span class="p">,</span> <span class="n">knn_pdfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">stn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">official_id</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Processing kNN for </span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_nearest</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Get spatial kNN</span>
            <span class="n">k_nbrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">nbr_stns</span> <span class="o">=</span> <span class="n">k_nbrs</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">knn_df</span><span class="p">,</span> <span class="n">knn_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_knn_pmf_inputs</span><span class="p">(</span><span class="n">nbr_stns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_df</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span> 

            <span class="c1"># Compute Equal Weighting (EW) PMF/PDF</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">NN_EW_</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">knn_pmfs</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">knn_pdfs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_knn_pmf_pdf</span><span class="p">(</span><span class="n">knn_df</span><span class="p">,</span> <span class="n">knn_cols</span><span class="p">)</span>

            <span class="c1"># Compute IDW-based PMF/PDF</span>
            <span class="n">k_nbrs</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">k_nbrs</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">)</span>
            <span class="n">distance_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_weights</span><span class="p">(</span><span class="n">k_nbrs</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">NN_IDW_</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">knn_pmfs</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">knn_pdfs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_knn_pmf_pdf</span><span class="p">(</span><span class="n">knn_df</span><span class="p">,</span> <span class="n">knn_cols</span><span class="p">,</span> <span class="n">distance_weights</span><span class="p">)</span>
                
            <span class="c1"># Get attribute-space kNN</span>
            <span class="n">k_nbrs_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data_attr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">nbr_stns_attr</span> <span class="o">=</span> <span class="n">k_nbrs_attr</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">knn_df_attr</span><span class="p">,</span> <span class="n">knn_attr_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_knn_pmf_inputs</span><span class="p">(</span><span class="n">nbr_stns_attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_df_attr</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>    
    
            <span class="c1"># Compute CAS-based PMF/PDF</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cas_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k_nbrs_attr</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">k_nbrs_attr</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">)</span>
                <span class="n">cas_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_weights</span><span class="p">(</span><span class="n">k_nbrs_attr</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">NN_CAS_</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">knn_pmfs</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">knn_pdfs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_knn_pmf_pdf</span><span class="p">(</span><span class="n">knn_df_attr</span><span class="p">,</span> <span class="n">knn_attr_cols</span><span class="p">,</span> <span class="n">cas_weights</span><span class="p">)</span>
            <span class="c1"># Compute CAS + Distance PMF/PDF</span>
            <span class="n">k_nbrs_dist_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">nbr_stns_dist_attr</span> <span class="o">=</span> <span class="n">k_nbrs_dist_attr</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">knn_df_dist_attr</span><span class="p">,</span> <span class="n">knn_dist_attr_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_knn_pmf_inputs</span><span class="p">(</span><span class="n">nbr_stns_dist_attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbr_df</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>  
            
            <span class="n">k_nbrs_dist_attr</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">k_nbrs_dist_attr</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_nbrs_dist_attr</span><span class="p">[</span><span class="s1">&#39;attr_dist&#39;</span><span class="p">],</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">cas_dist_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_weights</span><span class="p">(</span><span class="n">k_nbrs_dist_attr</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">NN_CASdist_</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">knn_pmfs</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">knn_pdfs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_knn_pmf_pdf</span><span class="p">(</span><span class="n">knn_df_dist_attr</span><span class="p">,</span> <span class="n">knn_dist_attr_cols</span><span class="p">,</span> <span class="n">cas_dist_weights</span><span class="p">)</span>
            <span class="c1"># Compute ensemble estimates</span>
            <span class="n">knn_sets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;EW&quot;</span><span class="p">,</span> <span class="n">knn_df</span><span class="p">,</span> <span class="n">knn_cols</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> 
                <span class="p">(</span><span class="s2">&quot;IDW&quot;</span><span class="p">,</span> <span class="n">knn_df</span><span class="p">,</span> <span class="n">knn_cols</span><span class="p">,</span> <span class="n">distance_weights</span><span class="p">),</span> 
                <span class="p">(</span><span class="s2">&quot;CAS&quot;</span><span class="p">,</span> <span class="n">knn_df_attr</span><span class="p">,</span> <span class="n">knn_attr_cols</span><span class="p">,</span> <span class="n">cas_weights</span><span class="p">),</span> 
                <span class="p">(</span><span class="s2">&quot;CASdist&quot;</span><span class="p">,</span> <span class="n">knn_df_dist_attr</span><span class="p">,</span> <span class="n">knn_dist_attr_cols</span><span class="p">,</span> <span class="n">cas_dist_weights</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">knn_sets</span><span class="p">:</span>
                <span class="n">ensemble_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">NN_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">_ensemble_</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">pmf_est</span><span class="p">,</span> <span class="n">pdf_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_distribution_estimates</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">ensemble_label</span><span class="p">,</span> <span class="n">distance_weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pmf_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">test_data</span>
                <span class="n">knn_pdfs</span><span class="p">[</span><span class="n">ensemble_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf_est</span>
                <span class="n">knn_pmfs</span><span class="p">[</span><span class="n">ensemble_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmf_est</span>
    
        <span class="k">return</span> <span class="n">knn_pmfs</span><span class="p">,</span> <span class="n">knn_pdfs</span>
        

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_pmf_from_predicted_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu_hat</span><span class="p">,</span> <span class="n">sd_hat</span><span class="p">):</span>
               
        <span class="n">norm_pdf</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">mu_hat</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">sd_hat</span><span class="p">])</span>
        <span class="n">pdf_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">norm_pdf</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">)</span>
        <span class="n">norm_pdf</span> <span class="o">/=</span> <span class="n">pdf_check</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">norm_pdf</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">norm_pdf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">norm_pdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">left_log</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right_log</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;   Predicted param pdf_check failed: </span><span class="si">{</span><span class="n">pdf_check</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">norm_pdf</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">norm_pdf</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s1"> new log range </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">left_log</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">right_log</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            
        <span class="n">norm_cdf</span> <span class="o">=</span> <span class="n">norm_pdf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">norm_cdf</span> <span class="o">/=</span> <span class="n">norm_cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">norm_pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">norm_cdf</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">norm_pmf</span><span class="p">,</span> <span class="n">norm_pdf</span>
        

    <span class="k">def</span><span class="w"> </span><span class="nf">process_best_knn_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knn_pmfs</span><span class="p">,</span> <span class="n">knn_pdfs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...processing knn result&#39;</span><span class="p">)</span>
        <span class="n">knn_results_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">knn_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EW&#39;</span><span class="p">,</span> <span class="s1">&#39;IDW&#39;</span><span class="p">,</span> <span class="s1">&#39;CAS&#39;</span><span class="p">,</span> <span class="s1">&#39;CASdist&#39;</span><span class="p">]:</span>
            <span class="n">knn_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">knn_pmfs</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">knn_type</span><span class="si">}</span><span class="s1">_&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>    
            <span class="n">min_knn</span><span class="p">,</span> <span class="n">best_knn</span> <span class="o">=</span> <span class="mf">1e9</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">knn_cols</span><span class="p">:</span> 
                <span class="n">q</span> <span class="o">=</span> <span class="n">knn_pmfs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">q_pdf</span> <span class="o">=</span> <span class="n">knn_pdfs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>               
                <span class="n">knn_kld</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_kld</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_pmf</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span>
                <span class="n">prior_bias</span> <span class="o">=</span> <span class="n">support</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">prior_bias</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">knn_kld</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
                    <span class="n">pct_bias</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">prior_bias</span> <span class="o">/</span> <span class="n">knn_kld</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;pct_of_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct_bias</span>
                    <span class="c1"># print(f&#39;    {c}: Prior bias {prior_bias:.3f} bits/sample bias {pct_bias:.1f}% of the KLD&#39;)</span>
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">knn_kld</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">knn_kld</span> <span class="o">&lt;</span> <span class="n">min_knn</span><span class="p">:</span>
                    <span class="n">min_knn</span> <span class="o">=</span> <span class="n">knn_kld</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">best_knn</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_pdf</span><span class="p">)</span>
            <span class="n">knn_results_dict</span><span class="p">[</span><span class="n">knn_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_knn</span>
        <span class="k">return</span> <span class="n">knn_results_dict</span>

        
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_kld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Ensure q is at least 2D for consistent broadcasting</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#&amp; (q &gt; 0)</span>
        <span class="n">kld_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">unsupported_mass</span> <span class="o">=</span> <span class="n">check_support_coverage</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">prior_bias</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">q_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="p">[</span><span class="n">prior</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">q</span><span class="p">]</span>
            <span class="n">q_mod</span> <span class="o">/=</span> <span class="n">q_mod</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">prior_bias</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">q_mod</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q_mod</span>
            
        <span class="n">prior_bias_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">prior_bias</span><span class="p">,</span> 
            <span class="s1">&#39;prior&#39;</span><span class="p">:</span> <span class="n">prior</span><span class="p">,</span>
            <span class="s1">&#39;unsupported_mass&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">unsupported_mass</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">q</span><span class="p">),</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">prior_bias_dict</span>
        

    <span class="k">def</span><span class="w"> </span><span class="nf">process_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">official_id</span> <span class="c1"># target catchment</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">kde_pmf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kde_pdf</span> <span class="o">=</span> <span class="n">single_kde_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_uar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ...processed single kde fit&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_pmf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_pdf</span> <span class="o">=</span> <span class="n">adaptive_kde</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drainage_area_km2</span><span class="p">)</span>        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ...adaptive (baseline) kde fit&#39;</span><span class="p">)</span>
        
        <span class="c1"># compute parametric PMFs (Lognorm MLE and predicted params) for the target</span>
        <span class="c1"># compute the pmf from the lognorm parameters predicted from catchment attributes</span>
        <span class="n">mom_param_pmf</span><span class="p">,</span> <span class="n">mom_param_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_pmf_from_predicted_params</span><span class="p">(</span><span class="s1">&#39;predicted_LN_MMO_mu_hat&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted_LN_MMO_sd_hat&#39;</span><span class="p">)</span>
        <span class="n">kld</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_kld</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_pmf</span><span class="p">,</span> <span class="n">mom_param_pmf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;LN_MOM_DKL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kld</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span><span class="p">[</span><span class="s1">&#39;LN_MOM_DKL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ...processed pmf from predicted MOM parameters&#39;</span><span class="p">)</span>
        
        <span class="n">predicted_param_pmf</span><span class="p">,</span> <span class="n">predicted_param_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_pmf_from_predicted_params</span><span class="p">(</span><span class="s1">&#39;predicted_mean_logx&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted_sd_logx&#39;</span><span class="p">)</span>
        <span class="n">kld</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_kld</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_pmf</span><span class="p">,</span> <span class="n">predicted_param_pmf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;LN_predicted_params_DKL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kld</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span><span class="p">[</span><span class="s1">&#39;LN_predicted_params_DKL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ...processed pmf from direct predicted LN parameters&#39;</span><span class="p">)</span>
        
        <span class="n">tc</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">knn_pmf_estimates</span><span class="p">,</span> <span class="n">knn_pdf_estimates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_pmf_estimation</span><span class="p">()</span>
        <span class="n">td</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time to complete knn: </span><span class="si">{</span><span class="n">td</span><span class="o">-</span><span class="n">tc</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">knn_results_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_best_knn_results</span><span class="p">(</span><span class="n">knn_pmf_estimates</span><span class="p">,</span> <span class="n">knn_pdf_estimates</span><span class="p">)</span>
        
        <span class="c1"># keep track of whether the lognorm yields incomplete support coverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_MLE_lognorm</span><span class="p">()</span>
            
        <span class="n">foo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DKL&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">foo</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Model&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;DKL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        
        <span class="n">output_figure</span><span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_log_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_uar</span><span class="p">,</span> <span class="n">predicted_param_pdf</span><span class="p">,</span> 
                      <span class="bp">self</span><span class="o">.</span><span class="n">lognorm_pdf</span><span class="p">,</span> <span class="n">mom_param_pdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kde_pdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_pdf</span><span class="p">,</span> 
                      <span class="n">knn_results_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_dict</span>
   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_problem_fig</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">n_bootstrap_samples</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">n_grid_points</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">12</span>
<span class="n">n_neighbours_to_check</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">k_nearest</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;05AD003&#39;</span><span class="p">,</span><span class="s1">&#39;05AD031&#39;</span><span class="p">,</span> <span class="s1">&#39;05AB022&#39;</span><span class="p">,</span> <span class="s1">&#39;05AB030&#39;</span><span class="p">,</span> <span class="s1">&#39;05AD031&#39;</span><span class="p">,</span> <span class="s1">&#39;12091050&#39;</span><span class="p">]</span>
<span class="n">n_processed</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">attr_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">stn</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span>
    <span class="n">result_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_knn_result&#39;</span><span class="p">)</span>
    <span class="n">support_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_knn_support_result&#39;</span><span class="p">)</span>
    <span class="c1"># if not os.path.exists(fpath): </span>
    
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">k_nearest</span><span class="o">=</span><span class="n">k_nearest</span><span class="p">,</span> <span class="n">n_neighbours_to_check</span><span class="o">=</span><span class="n">n_neighbours_to_check</span><span class="p">,</span> <span class="n">n_grid_points</span><span class="o">=</span><span class="n">n_grid_points</span><span class="p">)</span>
    <span class="n">left_log</span><span class="p">,</span> <span class="n">right_log</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">support_dict</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">process_target</span><span class="p">()</span>                
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))))</span>
    <span class="n">support_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">support_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))))</span>
    <span class="n">res</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">result_fpath</span><span class="p">)</span>
    <span class="n">support_res</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">support_fpath</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">9</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;05AD003&#39;</span><span class="p">,</span><span class="s1">&#39;05AD031&#39;</span><span class="p">,</span> <span class="s1">&#39;05AB022&#39;</span><span class="p">,</span> <span class="s1">&#39;05AB030&#39;</span><span class="p">,</span> <span class="s1">&#39;05AD031&#39;</span><span class="p">,</span> <span class="s1">&#39;12091050&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">n_processed</span> <span class="o">=</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">attr_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="n">stn</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;official_id&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="n">result_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stn</span><span class="si">}</span><span class="s1">_knn_result&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;attr_gdf&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/ss"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#question-what-is-the-best-general-approach-to-estimate-the-pdf-at-an-ungauged-location">Question: What is the best general approach to estimate the PDF at an ungauged location?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-import-and-model-setup">Data Import and Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-knn-distribution-estimation">Perform KNN distribution estimation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dan Kovacek
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>